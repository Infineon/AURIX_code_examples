/**********************************************************************************************************************
 * \file Slk_Ssw_Lbist.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 * 
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of 
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 * 
 * Boost Software License - Version 1.0 - August 17th, 2003
 * 
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and 
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 * 
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all 
 * derivative works of the Software, unless such copies or derivative works are solely in the form of 
 * machine-executable object code generated by a source language processor.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE 
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS 
 * IN THE SOFTWARE.
 *********************************************************************************************************************/


/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "SafetyLiteKit/Slk_Main.h"
#include "SafetyLiteKit/Sw_StartUp/Slk_Ssw.h"
#include "SafetyLiteKit/Sw_StartUp/Slk_Ssw_Lbist.h"
#include "Ifx_Types.h"
#include "Ifx_Ssw_Infra.h"
#include "IfxScuLbist.h"
#include "IfxPort.h"
#include "IfxScuRcu.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/
#define SLK_LBIST_MAX_RUNS       3

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
LbistStatus g_LbistStatus; /* global variable to store the status of Lbist */

/*********************************************************************************************************************/
/*--------------------------------------------Private Variables/Constants--------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/
boolean slkScuLbistIsTerminatedProperly(void);
boolean slkScuLbistIsTerminatedPORST(void);
void evaluateLbistResult(void);
void checkLbistStatus(void);

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
/*
 * The RSTSTAT.B.LBTERM status bit indicates if LBIST execution was properly terminated
 * */
boolean slkScuLbistIsTerminatedProperly(void)
{
    return (boolean)MODULE_SCU.RSTSTAT.B.LBTERM;
}

/*
 * The RSTSTAT.LBPORST status bit indicates if LBIST execution was terminated earlier due to a PORST assertion
 * */
boolean slkScuLbistIsTerminatedPORST(void)
{
    return (boolean)MODULE_SCU.RSTSTAT.B.LBPORST;
}

/*
 * Function trigger LBIST via Application software
 *  SM:MCU:LBIST_CFG
 * */
void slkTriggerLbist(void)
{
    /* Increment counter variable which counts the LBIST requests via Application SW
     * This variable is located in SCR XRAM memory to not be changed by LBIST.
     * */
    g_SswRunCount->lbistAppSwReq++;

    /* As we coming from Cold PORST, and to store lbist execution counter, it is required to clear Cold reset status.
     * Therefore, MODULE_SCU.RSTSTAT.U is also store in g_SswRunCount->RSTSTAT.U which is located in SCR XRAM memory.
     * This is then used in slkEvaluateReset() to used for further processing */
    g_SswRunCount->RSTSTAT.U = MODULE_SCU.RSTSTAT.U;

    IfxScuWdt_clearGlobalSafetyEndinitInline(IfxScuWdt_getGlobalSafetyEndinitPasswordInline());
    MODULE_SCU.LBISTCTRL0.B.LBISTRES = 1;
    IfxScuWdt_setGlobalSafetyEndinitInline(IfxScuWdt_getGlobalSafetyEndinitPasswordInline());

    /* Clear COLD PORST reason to preserve the data on the SCR XRAM after LBIST trigger i.e if not cleared,
     * then SCR XRAM will be initialized */
    IfxScuRcu_clearColdResetStatus();

    /* Default signature for TC375-A device i.e. look to Appendix  */
    IfxScuLbist_triggerInline(&IfxScuLbist_defaultConfig);

    while(1)
    {
        __nop(); /* After triggering LBIST wait for warm reset */
    }
}

/*
 * Evaluate LBIST result
 * LBIST failed when trigger from FW Boot or
 * Trigger LBIST by application software(coming from cold reset) if it is not trigger in FW Boot
 * */
void evaluateLbistResult(void)
{
    boolean lbistHasPassed;

    /* coming from cold PORST, if LBIST correctly executed */
    if ((g_LbistStatus.lbistNotTerminatedByPORST == passed) &&
        (g_LbistStatus.lbistTerminatedProperly == passed)   &&
        (g_LbistStatus.lbistDone == passed))
    {
        /* This variable is located in SCR XRAM memory */
        g_SswRunCount->lbistRuns++;

        /* Default signature for TC375-A device i.e. look to Appendix */
        lbistHasPassed = IfxScuLbist_evaluateResult(IfxScuLbist_defaultConfig.signature);

        uint16 password = IfxScuWdt_getSafetyWatchdogPasswordInline();
        IfxScuWdt_clearSafetyEndinitInline(password);

        /* Reset LBIST module and wait till reset is done */
        MODULE_SCU.LBISTCTRL0.B.LBISTRES = 1;
        IfxScuWdt_setSafetyEndinitInline(password);

        uint8 timeout = 0xFF;
        while (MODULE_SCU.LBISTCTRL0.B.LBISTDONE == 1U && timeout > 0)
        {
            timeout--;
        }

        /* check if the LBIST is passed */
        if (TRUE == lbistHasPassed)
        {
            g_SlkStatus.sswStatus.lbistStatus = passed;
            g_LbistStatus.deviceNotDefect = passed;
        }
        /* LBIST failed when trigger from FW Boot */
        else
        {
            g_SlkStatus.sswStatus.lbistStatus = failed;
            if (g_SswRunCount->lbistRuns < SLK_LBIST_MAX_RUNS)
            {
                /* Trigger LBIST */
                slkTriggerLbist();
            }
            else
            {
                /* LBIST has failed three consecutive times, device has to be considered as defect. */
                g_LbistStatus.deviceNotDefect = failed;
            }
        }
    }
    /* if the LBIST was not trigger yet or failed */
    else
    {
        g_SlkStatus.sswStatus.lbistStatus = failed;
        if (g_SswRunCount->lbistRuns < SLK_LBIST_MAX_RUNS)
        {
            /* Trigger LBIST */
            slkTriggerLbist();
        }
        else
        {
            /* LBIST has failed three consecutive times, device has to be considered as defect. */
            g_LbistStatus.deviceNotDefect = failed;
        }
    }
}

/*
 * Check the LBIST status
 * */
void checkLbistStatus(void)
{
    /* check if LBIST was terminated by a PORST i.e. if not terminated then move forward with checks*/
    if (FALSE == slkScuLbistIsTerminatedPORST())
    {
        g_LbistStatus.lbistNotTerminatedByPORST = passed;

        /* check if LBIST was terminated Properly */
        if (TRUE == slkScuLbistIsTerminatedProperly())
        {
            g_LbistStatus.lbistTerminatedProperly = passed;

            /* Check if LBIST was already executed */
            if (TRUE == IfxScuLbist_isDone())
            {
                g_LbistStatus.lbistDone = passed;
            }
            else
            {
                g_LbistStatus.lbistDone = failed;
            }
        }
        /* If LBIST was not terminated properly then check if cold power reset and trigger LBIST */
        else
        {
            g_LbistStatus.lbistTerminatedProperly = failed;
        }
    }
    /* If LBIST was early terminated because of PORST then check if cold-POR and trigger LBIST */
    else
    {
        g_LbistStatus.lbistNotTerminatedByPORST = failed;
    }
}

/*
 * This function is for LBIST execution and result check
 * SM:MCU:LBIST_RESULT
 * */
void slkSswLbist(void)
{
    g_LbistStatus.lbistNotTerminatedByPORST = notEvaluated;
    g_LbistStatus.lbistTerminatedProperly = notEvaluated;
    g_LbistStatus.lbistDone = notEvaluated;
    g_LbistStatus.deviceNotDefect = notEvaluated;
    g_SlkStatus.sswStatus.lbistStatus = notEvaluated;


    /* Evaluate LBIST only after cold power reset or
     * when LBIST was trigger by application software after coming from Cold PORST */
    if (Ifx_Ssw_isColdPoweronReset() ||
        slkScuLbistIsTerminatedProperly())
    {
        /* check the LBIST status */
         checkLbistStatus();

         /* Evaluate LBIST result */
         evaluateLbistResult();
    }

}
