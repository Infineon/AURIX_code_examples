/**********************************************************************************************************************
 * \file    Slk_NvmPflash.c
  * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "SafetyLiteKit/Safe_Computation/Slk_Fce.h"
#include "SafetyLiteKit/Safe_Computation/Slk_NvmPflash.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/
#define DATA_LENGTH   88                 /* Message data size in words (32-bit)  */
#define NUM_OF_PAGES  10                 /*number of pages to be check after the occurrence of Double bit error (DBE)*/

/* Setting macro for the expected result of the calculation */
#define CRC_EXPECTED_RESULT_IC       0xBF2AD640                 /* IC: Integrity Check                               */
#define CRC_EXPECTED_RESULT_UC       0xA7EE4C1C                 /* UC: Update Check                                  */

/* Cached address where the user want to store the safety data i.e. Bank Pf1 */
#define PFLASH1_START_ADDRESS_IC      0xA0400000
/* Cached address where the user want to store the safety data i.e. Bank Pf0 */
#define PFLASH0_START_ADDRESS_UC      0xA0200000
#define PFLASH0_DBE_ADDRESS           0xA0200020        /* address where double bit error is injected */

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
boolean doubleBitErrorOccur = FALSE;

/*********************************************************************************************************************/
/*--------------------------------------------Private Variables/Constants--------------------------------------------*/
/*********************************************************************************************************************/
/* data stored at Pf0 memory space for SM:NVM.PFLASH:INTEGRITY_CHECK */
const uint32 dummySafetyDataIc [DATA_LENGTH_WORDS_IC] __at(PFLASH1_START_ADDRESS_IC)=
{
    0xbe9957bb, 0x1c706c1e, 0x14c3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4, 0xe8a97d48,
    0x89367f27, 0x70095984, 0xec030f75, 0xdc22f8d4, 0xd951407b, 0x34ae18c6, 0x4d47ba7d, 0x0e2e4622, 0x4a2e90d3,
    0xdaec3752, 0xcd3ed11c, 0x36b416b7, 0x8ea28658, 0xdd37eee3, 0x23928b62, 0x84eb4b22,
};

/* data stored at Pf1 memory space for SM:NVM.PFLASH:UPDATE_CHECK is equal to 32 bytes and also then ten pages
 * for SM:NVM.PFLASH:WL_FAIL_DETECT when Double bit error is injected */
const uint32 dummySafetyDataUc [DATA_LENGTH] __at(PFLASH0_START_ADDRESS_UC)=
{
    /* initial data at Single bit error inject Address*/
    0x0e9957bb, 0x1c706c1e, 0x14c3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
    /* initial data at double bit error inject Address and ten pages after this for SM:NVM.PFLASH:WL_FAIL_DETECT*/
    0x0e9957bb, 0x1c706c1e, 0x14c3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
    /* initial data at multiple bit error inject Address*/
    0x0e9957bb, 0x1c706c1e, 0x14c3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
    0x549957bb, 0x1c706c1e, 0xeec3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
    0x549957bb, 0x1c706c1e, 0xeec3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
    0x549957bb, 0x1c706c1e, 0xeec3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
    0x549957bb, 0x1c706c1e, 0xeec3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
    0x549957bb, 0x1c706c1e, 0xeec3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
    0x549957bb, 0x1c706c1e, 0xeec3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
    0x549957bb, 0x1c706c1e, 0xeec3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
    0x549957bb, 0x1c706c1e, 0xeec3db3f, 0x7fb17a93, 0xb0d9d5a7, 0x768093e0, 0x88b206a0, 0xc51299e4,
};

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
/*
 * Function to enable flag when DBE occur
 */
void enableWlFailDetectPFLASH(void)
{
    doubleBitErrorOccur = TRUE;
}

/*
 * Data integrity by check by CRC calculation comparison
 * SM:NVM.PFLASH:INTEGRITY_CHECK
 */
void runIntegrityCheckPFLASH(void)
{
    uint32 *safetyDataIntegrityCheck = (uint32 * )PFLASH1_START_ADDRESS_IC;

    /* CRC calculation with FCE Kernel 0 (CRC32) */
    runCrcCheckFCE(CRC_EXPECTED_RESULT_IC, safetyDataIntegrityCheck, DATA_LENGTH_WORDS_IC);
}

/*
 * Update data check by CRC calculation comparison
 * SM:NVM.PFLASH:UPDATE_CHECK
 */
void runUpdateCheckPFLASH(uint32 startAddress)
{
    uint32 *safetyDataPflashUpdateCheck = (uint32 * )startAddress;
    /* CRC calculation with FCE Kernel 0 (CRC32) */
    runCrcCheckFCE(CRC_EXPECTED_RESULT_UC, safetyDataPflashUpdateCheck, DATA_LENGTH_WORDS_UC);
}

/* read the 10 pages after double bit error injected address
 * SM:NVM.PFLASH:WL_FAIL_DETECT
 */
void runWordlineFailDetectPFLASH(void)
{
    uint32 i;
    uint32 *dataWlFaildetectPFLASH[NUM_OF_PAGES];

    /* read 10 pages to check if any page is corrupted */
    for(i=0; i < NUM_OF_PAGES; i++)
    {
        dataWlFaildetectPFLASH[i] = (uint32 * )(PFLASH0_DBE_ADDRESS + (i*0x10));
    }
    /* CRC calculation with FCE Kernel 0 (CRC32) can be done to check data integrity but as
     * we are reading 10 pages, if the data is corrupted, then Multi bit error will occur and alarm will be generated*/
    /*    runCrcCheckFCE(0xDA35427E, pflashWlFaildetectData, 80); */
}
