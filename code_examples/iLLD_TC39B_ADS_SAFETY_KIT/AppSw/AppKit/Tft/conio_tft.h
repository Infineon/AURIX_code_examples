/**********************************************************************************************************************
 * \file conio_tft.h
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

#ifndef CONIO_TFT_H
#define CONIO_TFT_H

/******************************************************************************/
/*----------------------------------Includes----------------------------------*/
/******************************************************************************/
#include "conio_cfg.h"
#include "font_8_12.h"
#include "tfthw.h"
#include <stdarg.h>

#include "AppKit_Cfg.h"
#include "Configuration.h"
#include "IfxCpu_cfg.h"

#if defined(__DCC__)
    #if CPU_WHICH_SERVICE_TFT == 0
    #pragma section DATA ".data_cpu0" ".bss_cpu0" far-absolute RW
    #pragma section CODE ".text_cpu0"
    #elif ((CPU_WHICH_SERVICE_TFT == 1) && (CPU_WHICH_SERVICE_TFT < IFXCPU_NUM_MODULES))
    #pragma section DATA ".data_cpu1" ".bss_cpu1" far-absolute RW
    #pragma section CODE ".text_cpu1"
    #elif ((CPU_WHICH_SERVICE_TFT == 2) && (CPU_WHICH_SERVICE_TFT < IFXCPU_NUM_MODULES))
    #pragma section DATA ".data_cpu2" ".bss_cpu2" far-absolute RW
    #pragma section CODE ".text_cpu2"
    #elif ((CPU_WHICH_SERVICE_TFT == 3) && (CPU_WHICH_SERVICE_TFT < IFXCPU_NUM_MODULES))
    #pragma section DATA ".data_cpu3" ".bss_cpu3" far-absolute RW
    #pragma section CODE ".text_cpu3"
    #elif ((CPU_WHICH_SERVICE_TFT == 4) && (CPU_WHICH_SERVICE_TFT < IFXCPU_NUM_MODULES))
    #pragma section DATA ".data_cpu4" ".bss_cpu4" far-absolute RW
    #pragma section CODE ".text_cpu4"
    #elif ((CPU_WHICH_SERVICE_TFT == 5) && (CPU_WHICH_SERVICE_TFT < IFXCPU_NUM_MODULES))
    #pragma section DATA ".data_cpu5" ".bss_cpu5" far-absolute RW
    #pragma section CODE ".text_cpu5"
    #endif
#endif

/******************************************************************************/
/*-----------------------------------Macros-----------------------------------*/
/******************************************************************************/
#define COLOR_BLACK 0
#define COLOR_WHITE 1
#define COLOR_RED 2
#define COLOR_GREEN 3
#define COLOR_BROWN 4
#define COLOR_BLUE 5
#define COLOR_MAGENTA 6
#define COLOR_CYAN 7
#define COLOR_LIGHTGRAY 8
#define COLOR_DARKGRAY 9
#define COLOR_LIGHTRED 10
#define COLOR_LIGHTGREEN 11
#define COLOR_YELLOW 12
#define COLOR_LIGHTBLUE 13
#define COLOR_LIGHTMAGENTA 14
#define COLOR_LIGHTCYAN 15

#define  MENU_BACKGRND COLOR_BLUE
#define  BAR_BACKGRND COLOR_BLUE

//it is not rgb it is bgr, because LSB shifted first
//RGB for DAS and BGR for display

#define COLOR_RGB(r, g, b)        (((r & 0xF8) << 8) | ((g & 0xFC) << 3) | ((b & 0xF8) >> 3))
#define COLOR_BGR(r, g, b)        (((b & 0xF8) << 8) | ((g & 0xFC) << 3) | ((r & 0xF8) >> 3))


#define COLOR_RGB_BLACK         COLOR_RGB(0, 0, 0)            //0x0000
#define COLOR_RGB_RED           COLOR_RGB(255, 0, 0)          //0xF800
#define COLOR_RGB_GREEN         COLOR_RGB(0, 255, 0)          //0x07E0
#define COLOR_RGB_BROWN         COLOR_RGB(139, 69, 19)        //0x0 // 139 69 19
#define COLOR_RGB_BLUE          COLOR_RGB(0, 0, 255)          //0x001F
#define COLOR_RGB_MAGENTA       COLOR_RGB(255, 0, 255)        //0xF81F
#define COLOR_RGB_CYAN          COLOR_RGB(0, 255, 255)        //0x07FF
#define COLOR_RGB_LIGHTGRAY     COLOR_RGB(200, 200, 200)      //0xCE59  // 200 200 200
#define COLOR_RGB_DARKGRAY      COLOR_RGB(80, 80, 80)         //0x528A  //  80  80  80
#define COLOR_RGB_LIGHTRED      COLOR_RGB(240, 128, 128)      //0x0 // 240 128 128
#define COLOR_RGB_LIGHTGREEN    COLOR_RGB(128, 240, 128)      //0x0 // 128 240 128
#define COLOR_RGB_YELLOW        COLOR_RGB(255, 255, 0)        //0xFFE0
#define COLOR_RGB_LIGHTBLUE     COLOR_RGB(128, 128, 240)      //0x0 // 128 128 240
#define COLOR_RGB_LIGHTMAGENTA  COLOR_RGB(240, 128, 240)      //0x0 // 240 128 240
#define COLOR_RGB_LIGHTCYAN     COLOR_RGB(128, 240, 240)      //0x0 // 128 240 240
#define COLOR_RGB_WHITE         COLOR_RGB(255, 255, 255)      //0xFFFF

#define COLOR_RGB_SIMPSONS      COLOR_RGB(255, 217, 15)       // 255 217 15

#define COLOR_BGR_BLACK         COLOR_BGR(0, 0, 0)            //0x0000
#define COLOR_BGR_RED           COLOR_BGR(255, 0, 0)          //0xF800
#define COLOR_BGR_GREEN         COLOR_BGR(0, 255, 0)          //0x07E0
#define COLOR_BGR_BROWN         COLOR_BGR(139, 69, 19)        //0x0 // 139 69 19
#define COLOR_BGR_BLUE          COLOR_BGR(0, 0, 255)          //0x001F
#define COLOR_BGR_MAGENTA       COLOR_BGR(255, 0, 255)        //0xF81F
#define COLOR_BGR_CYAN          COLOR_BGR(0, 255, 255)        //0x07FF
#define COLOR_BGR_LIGHTGRAY     COLOR_BGR(200, 200, 200)      //0xCE59  // 200 200 200
#define COLOR_BGR_DARKGRAY      COLOR_BGR(80, 80, 80)         //0x528A  //  80  80  80
#define COLOR_BGR_LIGHTRED      COLOR_BGR(240, 128, 128)      //0x0 // 240 128 128
#define COLOR_BGR_LIGHTGREEN    COLOR_BGR(128, 240, 128)      //0x0 // 128 240 128
#define COLOR_BGR_YELLOW        COLOR_BGR(255, 255, 0)        //0xFFE0
#define COLOR_BGR_LIGHTBLUE     COLOR_BGR(128, 128, 240)      //0x0 // 128 128 240
#define COLOR_BGR_LIGHTMAGENTA  COLOR_BGR(240, 128, 240)      //0x0 // 240 128 240
#define COLOR_BGR_LIGHTCYAN     COLOR_BGR(128, 240, 240)      //0x0 // 128 240 240
#define COLOR_BGR_WHITE         COLOR_BGR(255, 255, 255)      //0xFFFF

#define COLOR_BGR_SIMPSONS      COLOR_BGR(255, 217, 15)       // 255 217 15

#define TOKEN_DISPLAY_GRAPHICS_LINE 0x0000FFE1
#define TOKEN_DISPLAY_ASCII_CLRSCR 0x0000FFE2
#define TOKEN_DISPLAY_GRAPHICS_CLRSCR 0x0000FFE3
#define TOKEN_DISPLAY_ASCII_PRINTFXY 0x0000FFE4
#define TOKEN_DISPLAY_GRAPHICS_PRINTFXY 0x0000FFE5
#define TOKEN_DISPLAY_ASCII_PRINTF 0x0000FFE6
#define TOKEN_DISPLAY_ASCII_CLREOL 0x0000FFE7
#define TOKEN_DISPLAY_ASCII_TEXTATTR 0x0000FFE8
#define TOKEN_DISPLAY_ASCII_TEXTCOLOR 0x0000FFE9
#define TOKEN_DISPLAY_ASCII_TEXTBACKGROUND 0x0000FFEA
#define TOKEN_DISPLAY_GRAPHICS_TEXTATTR 0x0000FFEB
#define TOKEN_DISPLAY_GRAPHICS_TEXTCOLOR 0x0000FFEC
#define TOKEN_DISPLAY_GRAPHICS_TEXTBACKGROUND 0x0000FFED
#define TOKEN_DISPLAY_ASCII_TEXTCHANGEBACKGROUND 0x0000FFEE
#define TOKEN_DISPLAY_ASCII_TEXTCHANGEFOREGROUND 0x0000FFEF
#define TOKEN_DISPLAY_ASCII_TEXTCHANGECOLOR 0x0000FFF0
#define TOKEN_DISPLAY_ASCII_CPUTS 0x0000FFF1
#define TOKEN_DISPLAY_ASCII_GRAPHICS_CPUTS 0x0000FFF2
#define TOKEN_DISPLAY_ASCII_GOTOXY 0x0000FFF3
#define TOKEN_DISPLAY_GRAPHICS_GOTOXY 0x0000FFF4
#define TOKEN_DISPLAY_GRAPHICS_PRINTF 0x0000FFF5
#define TOKEN_DISPLAY_GRAPHICS_CPUTS 0x0000FFF6

/******************************************************************************/
/*--------------------------------Enumerations--------------------------------*/
/******************************************************************************/
/*!< \enum Mode of for single variable display */
/*!< \brief Define the Mode of display */
typedef enum
{
    DISPINT32=0,          //!< Integer32
    DISPUINT32,         //!< Unsigned32
    DISPHEX8,         //!< Hex8
    DISPHEX16,        //!< Hex16
    DISPHEX32         //!< Hex32
} TVARMODE;

/* TMODE is in conio_cfg.h */
/* TDISPLAYMODE is in conio_cfg.h */
/* TDIALOGMODE is in conio_cfg.h */

/******************************************************************************/
/*-----------------------------Data Structures--------------------------------*/
/******************************************************************************/
//The graphicswidth is the amount of pixels used for graphics output
//because the last lines are always characters the array is reduce by one character line
#define GRAPHICSWIDTH (TFT_XSIZE*(TFT_YSIZE-FONT_YSIZE))    //last line is bar
//2 color picture will take 1bit for 72960pixel = 9120bytes
//4 color picture will take 2bit for 72960pixel = 18240bytes
//16 color picture will take 4bit for 72960pixel = 36480bytes
//256 color picture will take 1byte for 72960pixel = 72960bytes

//the pixelvalue is an index to the following color tables
//if 2 color mode is used index 0..1 is used, 4 color mode 0..3 ....
#define TCOLORTABLE_SIZE 256
#define TCOLORTABLEASCII_SIZE 16

typedef uint16 TCOLORTABLE[TCOLORTABLE_SIZE];    //always 256 colors
typedef uint16 TCOLORTABLEASCII[TCOLORTABLEASCII_SIZE];    //always 16 colors

#define TERMINAL_MAXX (TFT_XSIZE/FONT_XSIZE)        //the maximum display width of the tft in characters
#define TERMINAL_MAXY (TFT_YSIZE/FONT_YSIZE)        //the maximum display height of the tft in characters

typedef uint8 TDISPLAY[TERMINAL_MAXX * (TERMINAL_MAXY - 1)];    //the characters of standard text output
typedef uint8 TDISPLAYCOLOR[TERMINAL_MAXX * (TERMINAL_MAXY - 1)];   //the colors of the characters
typedef uint8 TDISPLAYBAR[TERMINAL_MAXX];   //the characters of the bar
typedef uint8 TDISPLAYBARCOLOR[TERMINAL_MAXX];  //the colors of the bar

//this structure is very important to understand the menu handling
typedef struct DISPLAYENTRY
{
    uint8 color_display;        //upper most 4 bits are background colore, lower 4 bits text color
    //if the cursor is not inside the are this color information will be taken to display the text
    uint8 color_select;         //if the cursor is inside the area, the text will be shown in this color
    sint8 xmin;                 //provides the information where the menu entry is starting
    sint8 xmax;                 //and ending
    sint8 y;                    //height information, only one line height is used as menu entry
    void (*select) (sint32 ind, struct DISPLAYENTRY * pdisplayentry);   //this function will be called in case of select, if NULL nothing will happen
    void (*display) (sint32 ind, struct DISPLAYENTRY * pdisplayentry);  //this function will be called to display the text
     sint32 (*input) (sint32 ind, struct DISPLAYENTRY * pdisplayentry); //this function will be called if an text input is required, the keyboard window will be opened
    uint8 text[TERMINAL_MAXX];  //the text
    uint8 symbol;               //the symbol number
} TDISPLAYENTRY, *pTDISPLAYENTRY;

/* TDISPLAY_INFO is in conio_cfg.h */

//the conio driver structure
typedef struct CONIO_DRIVER
{
    TDISPLAYENTRY *pmenulist;
    TDISPLAYENTRY *pstdlist;
    TDISPLAY_INFO display[CONIO_MAXDISPLAYS]; //contains the infos for the different displays, and pointers to buffers
    uint32 *pdasmirror;
    uint32 dasstatus;
    TDISPLAYMODE dasdisplaymode;   //Bits 0...6 is id for mode
    sint32 cursorstatus;        //cursorstatus information, can be also off
    TDISPLAYMODE displaymode;   //Bits 0...6 is id for mode
    TDIALOGMODE dialogmode;     //set to the dialog to show
    uint8 scanfdescr[20];       //text for keyboard entry description
    uint8 scanftext[20];        //text for keyboard entry
    sint32 (*input) (sint32 ind, TDISPLAYENTRY * pdisplayentry);
    sint32 inputid;             //in keyboard mode this id contains the entry selected for input
    sint8 scanfx;               //actual position for keyboard entry
    uint8 blinky;               //blinky cursor, to show where the input marker is
#if USE_SAFETYKIT_TFT
    TDISPLAYENTRY *psmulist;
#endif /* USE_SAFETYKIT_TFT */
} TCONIO_DRIVER;


//a structure to measure the runtime and to show the actual time
typedef struct CONTROL
{
    uint32 timebeg[32];
    uint32 timeend[32];
    uint32 timeus[32];
} TCONTROL;


//a structure to measure the runtime and to handle sdcard
typedef struct CONTROLMENU
{
    float32 cpuseconds;
    float32 cpusecondsdelta;
} TCONTROLMENU;

/******************************************************************************/
/*------------------------------Global variables------------------------------*/
/******************************************************************************/
IFX_EXTERN TCONIO_DRIVER conio_driver;
IFX_EXTERN TCONTROL control;

/******************************************************************************/
/*-------------------------Function Prototypes--------------------------------*/
/******************************************************************************/
//the function is called with a valid cursor position and processes the commands and also triggers afterwards
//the output to the TFT
IFX_EXTERN void conio_init (const pTCONIODMENTRY dm_list);

#if !USE_SAFETYKIT_TFT
IFX_EXTERN void conio_periodic (sint16 x, sint16 y, TDISPLAYENTRY * pmenulist, TDISPLAYENTRY * pstdlist);  //this function is called out of the timer tick
#else /* !USE_SAFETYKIT_TFT */
IFX_EXTERN void conio_periodic (sint16 x, sint16 y, TDISPLAYENTRY * pmenulist, TDISPLAYENTRY * pstdlist, TDISPLAYENTRY * psmulist);  //this function is called out of the timer tick
#endif /* !USE_SAFETYKIT_TFT */

//specific entries libtft.c
IFX_EXTERN void conio_ascii_putch (TDISPLAYMODE displaymode, uint8 ch);    /* Writes a character directly to the console. */
IFX_EXTERN int conio_ascii_getch (TDISPLAYMODE displaymode);   /* Reads a character directly from the console, without echo. */
IFX_EXTERN int conio_ascii_kbhit (TDISPLAYMODE displaymode);   /* Determines if a keyboard key was pressed. */
IFX_EXTERN void conio_ascii_cputs (TDISPLAYMODE displaymode, uint8 * s);   /* Outputs a string directly to the console. */
IFX_EXTERN uint8 *conio_ascii_cgets (TDISPLAYMODE displaymode, uint8 * s); /* Gets a string directly from the console.  */
IFX_EXTERN void conio_ascii_clrscr (TDISPLAYMODE displaymode);
IFX_EXTERN void conio_ascii_clreol (TDISPLAYMODE displaymode);
IFX_EXTERN void conio_ascii_gotoxy (TDISPLAYMODE displaymode, sint32 x, sint32 y);
IFX_EXTERN void conio_ascii_textcolor (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void conio_ascii_textbackground (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void conio_ascii_textattr (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void conio_ascii_textchangebackground (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void conio_ascii_textchangeforeground (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void conio_ascii_textchangecolor (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void conio_ascii_printfxy (TDISPLAYMODE displaymode, sint32 x, sint32 y, const uint8 * format, ...);
IFX_EXTERN void conio_ascii_printf (TDISPLAYMODE displaymode, const uint8 * format, ...);
IFX_EXTERN void conio_ascii_char (TDISPLAYMODE displaymode, sint32 x, sint32 y, uint8 ch, uint8 color);
IFX_EXTERN void conio_ascii_setcolortable (uint32 ind, uint32 r, uint32 g, uint32 b);
IFX_EXTERN void conio_ascii_printfvalue (TDISPLAYMODE displaymode, TVARMODE varmode, uint32 value);

IFX_EXTERN void conio_graphics_clrscr (TDISPLAYMODE displaymode);
IFX_EXTERN void conio_graphics_textattr (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void conio_graphics_gotoxy (TDISPLAYMODE displaymode, sint32 x, sint32 y);
IFX_EXTERN void conio_graphics_cputs (TDISPLAYMODE displaymode, uint8 * s);
IFX_EXTERN void conio_graphics_textcolor (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void conio_graphics_textbackground (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void conio_graphics_ascii_textattr (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void conio_graphics_printfxy (TDISPLAYMODE displaymode, sint32 x, sint32 y, const uint8 * format, ...);
IFX_EXTERN void conio_graphics_set (TDISPLAYMODE displaymode, sint32 x, sint32 y, uint8 color);
IFX_EXTERN void conio_graphics_line (TDISPLAYMODE displaymode, sint32 x1, sint32 y1, sint32 x2, sint32 y2, uint8 color);
IFX_EXTERN void conio_graphics_setcolortable (uint32 ind, uint32 r, uint32 g, uint32 b);
IFX_EXTERN void conio_graphics_char (TDISPLAYMODE displaymode, sint32 x, sint32 y, uint8 ch, uint8 color);

IFX_EXTERN void display_ascii_clrscr (TDISPLAYMODE displaymode);
IFX_EXTERN void display_ascii_printfxy (TDISPLAYMODE displaymode, sint32 x, sint32 y, const uint8 * format, ...);
IFX_EXTERN void display_ascii_printf (TDISPLAYMODE displaymode, const uint8 * format, ...);
IFX_EXTERN void display_ascii_clreol (TDISPLAYMODE displaymode);
IFX_EXTERN void display_ascii_textattr (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void display_ascii_textcolor (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void display_ascii_textbackground (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void display_ascii_textchangebackground (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void display_ascii_textchangeforeground (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void display_ascii_textchangecolor (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void display_ascii_cputs (TDISPLAYMODE displaymode, uint8 * s);
IFX_EXTERN void display_ascii_gotoxy (TDISPLAYMODE displaymode, sint32 x, sint32 y);

IFX_EXTERN void display_graphics_cputs (TDISPLAYMODE displaymode, uint8 * s);
IFX_EXTERN void display_graphics_printf (TDISPLAYMODE displaymode, const uint8 * format, ...);
IFX_EXTERN void display_graphics_gotoxy (TDISPLAYMODE displaymode, sint32 x, sint32 y);
IFX_EXTERN void display_graphics_printfxy (TDISPLAYMODE displaymode, sint32 x, sint32 y, const uint8 * format, ...);
IFX_EXTERN void display_graphics_clrscr (TDISPLAYMODE displaymode);
IFX_EXTERN void display_graphics_line (TDISPLAYMODE displaymode, sint32 x1, sint32 y1, sint32 x2, sint32 y2, uint8 color);
IFX_EXTERN void display_graphics_textattr (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void display_graphics_textcolor (TDISPLAYMODE displaymode, sint32 color);
IFX_EXTERN void display_graphics_textbackground (TDISPLAYMODE displaymode, sint32 color);

IFX_EXTERN void tft_graphic (TMODE mode, uint8 * pdisplay, uint8 * pdisplaycolor);
IFX_EXTERN void tft_ascii_bar (uint8 * pdisplay, uint8 * pdisplaycolor);
IFX_EXTERN void tft_ascii (TMODE mode, uint8 * pdisplay, uint8 * pdisplaycolor);

#if defined(__DCC__)
#pragma section CODE
#pragma section DATA RW
#endif

#endif /* CONIO_TFT_H */
