/**********************************************************************************************************************
 * \file SafetyKit_SSW_00_LBIST.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "SafetyKit_SSW.h"
#include "SafetyKit_SSW_00_LBIST.h"
#include "SafetyKit_Cfg.h"
#include "SafetyKit_Main.h"
#include "IfxScuLbist.h"
#include "Ifx_Ssw_Infra.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/
/* TC39x-BD has different signature than that of TC39x-BA/BB/BC
 * have a look to Appendix*/
#ifndef IFXSCULBIST_CFG_SIGNATURE_A_TC39X_BD
#ifndef IFX_CFG_LBIST_BODY_ENABLED
#define IFXSCULBIST_CFG_SIGNATURE_A_TC39X_BD    (0x95F1EC84)
#else
#define IFXSCULBIST_CFG_SIGNATURE_A_TC39X_BD    (0x6CBBBA57)
#endif
#endif
/* TC39x-BA, TC39x-BB,TC39x-BC and TC39x-BD has Chip revision ID as
*  0x10,     0x11,    0x12     and 0x13 */
#ifndef IFX_SCU_CHIPID_CHREV_TC39X_BD
#define IFX_SCU_CHIPID_CHREV_TC39X_BD   0x13
#endif

/*********************************************************************************************************************/
/*-------------------------------------------------Data Structures---------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*---------------------------------------------------Enumerations----------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------Exported Variables/Constants---------------------------------------------*/
/*********************************************************************************************************************/
IFX_CONST IfxScuLbist_ParameterSet IfxScuLbist_defaultConfig_tc39x_bd = {
#ifndef IFX_CFG_LBIST_BODY_ENABLED

    .application     = IfxScuLbist_Application_pt,
    .freq            = IfxScuLbist_Freq_div6,
    .splitShiftSel   = IfxScuLbist_SplitShiftSel_fourScanPartitions,
    .seed            = IFXSCULBIST_CFG_SEED,
    .pattern         = IFXSCULBIST_CFG_PATTERN_A,
    .scanChainLength = IFXSCULBIST_CFG_SCANCHAINLENGTH,
    .signature       = IFXSCULBIST_CFG_SIGNATURE_A_TC39X_BD,
#else
    .application     = IfxScuLbist_Application_body,
    .freq            = IfxScuLbist_Freq_div6,
    .splitShiftSel   = IfxScuLbist_SplitShiftSel_fourScanPartitions,
    .seed            = IFXSCULBIST_CFG_SEED,
    .pattern         = IFXSCULBIST_CFG_PATTERN_A,
    .scanChainLength = IFXSCULBIST_CFG_SCANCHAINLENGTH,
    .signature       = IFXSCULBIST_CFG_SIGNATURE_A_TC39X_BD,
#endif
};

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/
boolean IfxScuLbist_isTerminatedPORST(void);

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
/*
 * This function is for LBIST execution and result check
 * SM:LBIST_CFG
 * SM:LBIST_RESULT
 * */
void safetyKitSswLbist(void)
{
    boolean lbistHasPassed;
    /* First of all check if it is a Cold PORST */
    if (Ifx_Ssw_isColdPoweronReset())
    {
        /* Initialize the SswStatus_XRAM data if it was a Cold PORST */
        g_sswStatusXram->lbistRuns = 0;
        g_sswStatusXram->lbistAppSwReq = 0;
    }

    /* check if LBIST was terminated by a PORST */
    if (FALSE == IfxScuLbist_isTerminatedPORST())
    {
        /* Check if LBIST was already executed, either within firmware of within application SSW */
        if (IfxScuLbist_isDone())
        {
            /* Increment execution counter variable (is not reset by WarmPORST) */
            g_sswStatusXram->lbistRuns++;

            /* SM:LBIST_RESULT */
            if ( IFX_SCU_CHIPID_CHREV_TC39X_BD == MODULE_SCU.CHIPID.B.CHREV)
            {
                /* Default signature for TC39X-BD device i.e. look to Appendix  */
                lbistHasPassed = IfxScuLbist_evaluateResult(IfxScuLbist_defaultConfig_tc39x_bd.signature);
            }
            else
            {
                /* Default signature for TC39X-BA/BB/BC device i.e. look to Appendix  */
                lbistHasPassed = IfxScuLbist_evaluateResult(IfxScuLbist_defaultConfig.signature);
            }
            uint16 password = IfxScuWdt_getSafetyWatchdogPasswordInline();
            IfxScuWdt_clearSafetyEndinitInline(password);
            /* Reset LBIST module and wait till reset is done */
            MODULE_SCU.LBISTCTRL0.B.LBISTRES = 1;
            IfxScuWdt_setSafetyEndinitInline(password);
            uint8 timeout = 0xFF;
            while (MODULE_SCU.LBISTCTRL0.B.LBISTDONE == 1U && timeout > 0)
            {
                timeout--;
            }

            if (lbistHasPassed)
            {
                g_SafetyKitStatus.sswStatus.lbistStatus = passed;
            }
            else
            {
                g_SafetyKitStatus.sswStatus.lbistStatus = failed;
                /* Check if another LBIST attempt should be started */
                if (g_sswStatusXram->lbistRuns < SAFETKIT_LBIST_MAX_RUNS)
                {
                    /* SM:LBIST_CFG */
                    safetyKitTriggerLbist();
                }
                else
                {
                    /* LBIST has failed three consecutive times, device has to be considered as defect. */
                    while (1);
                    __debug();
                }
            }
        }
        else
        {
            /* If LBIST was not yet executed and coming from a cold PORST execute LBIST here, within application start up software. */
#if SAFETYKIT_CFG_SSW_ENABLE_LBIST_APPSW
            if (Ifx_Ssw_isColdPoweronReset())
            {
                /* SM:LBIST_CFG */
                safetyKitTriggerLbist();
            }
#endif
        }
    }
    else
    {
        g_SafetyKitStatus.sswStatus.lbistStatus = failed;
    }
}

/*
 * The RSTSTAT.LBPORST status bit indicates if LBIST execution was terminated earlier due to a PORST assertion
 * */
boolean IfxScuLbist_isTerminatedPORST(void)
{
    return (boolean)MODULE_SCU.RSTSTAT.B.LBPORST;
}

/*
 * SM:LBIST_CFG
 * */
void safetyKitTriggerLbist(void)
{
    /* Increment counter variable which counts the LBIST requests via Application SW */
    g_sswStatusXram->lbistAppSwReq++;

    /* Clear COLD PORST reason to preserve the data on the SCR XRAM */
    IfxScuRcu_clearColdResetStatus();

    /* Trigger LBIST */
    if ( IFX_SCU_CHIPID_CHREV_TC39X_BD == MODULE_SCU.CHIPID.B.CHREV)
    {
        /* Default signature for TC39X-BD device i.e. look to Appendix  */
        IfxScuLbist_triggerInline(&IfxScuLbist_defaultConfig_tc39x_bd);
    }
    else
    {
        IfxScuLbist_triggerInline(&IfxScuLbist_defaultConfig);
    }

    while(1)
    {
        __nop(); /* After triggering LBIST wait for warm reset */
    }
}
