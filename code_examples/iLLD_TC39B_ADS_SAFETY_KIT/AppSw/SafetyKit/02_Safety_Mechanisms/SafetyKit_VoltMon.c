/**********************************************************************************************************************
 * \file SafetyKit_VoltMon.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/


/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "SafetyKit_VoltMon.h"
#include "SafetyKit_Main.h"
#include "SafetyKit_Cfg.h"
#include "IfxPmsEvr.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*-------------------------------------------------Data Structures---------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
/*
 * SM:PMS:VX_MONITOR_CFG and SM:PMS:MON_REDUNDANCY_CFG
 * */
void initVoltageMonitors(void)
{
    /* SM:PMS:VX_MONITOR_CFG */
    /* Set all Threshold parameters for each Vx_MONITOR in EVROVMON, EVROVMON2, EVRUVMON, EVRUVMON2 registers */
    IfxPmsEvr_setSecondaryOverVoltageThresholdMv(&MODULE_PMS, SWD_OV_VAL_MILLIVOLT,     IfxPmsEvr_SupplyMode_swd);
    IfxPmsEvr_setSecondaryUnderVoltageThresholdMv(&MODULE_PMS, SWD_UV_VAL_MILLIVOLT,     IfxPmsEvr_SupplyMode_swd);

    IfxPmsEvr_setSecondaryOverVoltageThresholdMv(&MODULE_PMS, EVR33_OV_VAL_MILLIVOLT,   IfxPmsEvr_SupplyMode_evr33);
    IfxPmsEvr_setSecondaryUnderVoltageThresholdMv(&MODULE_PMS, EVR33_UV_VAL_MILLIVOLT,   IfxPmsEvr_SupplyMode_evr33);

    IfxPmsEvr_setSecondaryOverVoltageThresholdMv(&MODULE_PMS, EVRC_OV_VAL_MILLIVOLT,    IfxPmsEvr_SupplyMode_evrc);
    IfxPmsEvr_setSecondaryUnderVoltageThresholdMv(&MODULE_PMS, EVRC_UV_VAL_MILLIVOLT,    IfxPmsEvr_SupplyMode_evrc);

    IfxPmsEvr_setSecondaryOverVoltageThresholdMv(&MODULE_PMS, SB_OV_VAL_MILLIVOLT,      IfxPmsEvr_SupplyMode_sb);
    IfxPmsEvr_setSecondaryUnderVoltageThresholdMv(&MODULE_PMS, SB_UV_VAL_MILLIVOLT,      IfxPmsEvr_SupplyMode_sb);

    IfxPmsEvr_setSecondaryOverVoltageThresholdMv(&MODULE_PMS, VDDM_OV_VAL_MILLIVOLT,    IfxPmsEvr_SupplyMode_vddm);
    IfxPmsEvr_setSecondaryUnderVoltageThresholdMv(&MODULE_PMS, VDDM_UV_VAL_MILLIVOLT,    IfxPmsEvr_SupplyMode_vddm);

    IfxPmsEvr_setSecondaryOverVoltageThresholdMv(&MODULE_PMS, PRE_OV_VAL_MILLIVOLT,     IfxPmsEvr_SupplyMode_evrpr);
    IfxPmsEvr_setSecondaryUnderVoltageThresholdMv(&MODULE_PMS, PRE_UV_VAL_MILLIVOLT,     IfxPmsEvr_SupplyMode_evrpr);

    /* Save the configured undervoltage limits of register EVRUVMON to a global struct to enable modification via TFT */
    g_SafetyKitStatus.voltStatus.vextVoltageUvLimit     = SWD_UV_VAL_MILLIVOLT  /1000;
    g_SafetyKitStatus.voltStatus.vddp3VoltageUvLimit    = EVR33_UV_VAL_MILLIVOLT / 1000;
    g_SafetyKitStatus.voltStatus.coreVoltageUvLimit     = EVRC_UV_VAL_MILLIVOLT /1000;

    /* Enable over- and undervoltage monitoring and direction of voltage crossing in the EVRMONCTRL register*/
    IfxPmsEvr_setOverVoltageMonitoringMode(&MODULE_PMS, IfxPmsEvr_OverVoltageMonitoring_lowToHighVoltageTransition,
            IfxPmsEvr_SupplyMode_swd);
    IfxPmsEvr_setUnderVoltageMonitoringMode(&MODULE_PMS, IfxPmsEvr_UnderVoltageMonitoring_highToLowVoltageTransition,
            IfxPmsEvr_SupplyMode_swd);

    IfxPmsEvr_setOverVoltageMonitoringMode(&MODULE_PMS, IfxPmsEvr_OverVoltageMonitoring_lowToHighVoltageTransition,
            IfxPmsEvr_SupplyMode_evr33);
    IfxPmsEvr_setUnderVoltageMonitoringMode(&MODULE_PMS, IfxPmsEvr_UnderVoltageMonitoring_highToLowVoltageTransition,
            IfxPmsEvr_SupplyMode_evr33);

    IfxPmsEvr_setOverVoltageMonitoringMode(&MODULE_PMS, IfxPmsEvr_OverVoltageMonitoring_lowToHighVoltageTransition,
            IfxPmsEvr_SupplyMode_evrc);
    IfxPmsEvr_setUnderVoltageMonitoringMode(&MODULE_PMS, IfxPmsEvr_UnderVoltageMonitoring_highToLowVoltageTransition,
            IfxPmsEvr_SupplyMode_evrc);

    /* SM:PMS:MON_REDUNDANCY_CFG */
    IfxScuWdt_clearSafetyEndinit(IfxScuWdt_getSafetyWatchdogPassword());

    /* Configure threshold parameters for each Vx_MONITOR (Primary voltage monitors) in HSMOVMON, HSMUVMON registers */
    /* +20mV just to have a different limit as EVROV*/
    PMS_HSMOVMON.B.SWDOVVAL = (uint8) (((SWD_OV_VAL_MILLIVOLT + 20) - 1050)  / 20);
    /* -20mV just to have a different limit as EVRUV*/
    PMS_HSMUVMON.B.SWDUVVAL = (uint8) (((SWD_UV_VAL_MILLIVOLT - 20) - 1050)  / 20);

    /* +20mV just to have a different limit as EVROV*/
    PMS_HSMOVMON.B.EVR33OVVAL = (uint8) (((EVR33_OV_VAL_MILLIVOLT + 20) - 937.5) / 15);
    /* -20mV just to have a different limit as EVRUV*/
    PMS_HSMUVMON.B.EVR33UVVAL = (uint8) (((EVR33_UV_VAL_MILLIVOLT - 20) - 937.5) / 15);

    /* +20mV just to have a different limit as EVROV*/
    PMS_HSMOVMON.B.EVRCOVVAL = (uint8) (((EVRC_OV_VAL_MILLIVOLT + 20) - 712.5) / 5);
    /* -20mV just to have a different limit as EVRUV*/
    PMS_HSMUVMON.B.EVRCUVVAL = (uint8) (((EVRC_UV_VAL_MILLIVOLT - 20) - 712.5) / 5);

    IfxScuWdt_setSafetyEndinit(IfxScuWdt_getSafetyWatchdogPassword());

    /* Initialize Lowest and Highest variables for runtime minimum maximum runtime tracking */
    g_SafetyKitStatus.voltStatus.vextVoltageLowest      = 6.0f;
    g_SafetyKitStatus.voltStatus.vextVoltageHighest     = 0.0f;

    g_SafetyKitStatus.voltStatus.vddp3VoltageLowest     = 6.0f;
    g_SafetyKitStatus.voltStatus.vddp3VoltageHighest    = 0.0f;

    g_SafetyKitStatus.voltStatus.coreVoltageLowest      = 6.0f;
    g_SafetyKitStatus.voltStatus.coreVoltageHighest     = 0.0f;
}

/*
 * Function gets the PMS voltage measurement
 * */
void getPmsVoltageMeasurements(void)
{
    /* We get the voltage result of the primary monitor */
    float32 vext = IfxPmsEvr_getAdcVextResult((float32)PMS_EVRADCSTAT.B.ADCSWDV);

    /* If new result is higher or lower then the actual Highest and Lowest variables
     * overwrite Highest and Lowest variables. */
    if(vext > g_SafetyKitStatus.voltStatus.vextVoltageHighest)
    {
        g_SafetyKitStatus.voltStatus.vextVoltageHighest = vext;
    }
    if(vext < g_SafetyKitStatus.voltStatus.vextVoltageLowest)
    {
        g_SafetyKitStatus.voltStatus.vextVoltageLowest = vext;
    }
    g_SafetyKitStatus.voltStatus.vextVoltage = vext;

    /* We get the voltage result of the primary monitor */
    float32 vddp3 = IfxPmsEvr_getAdcVddp3Result((float32)PMS_EVRADCSTAT.B.ADC33V);

    /* If new result is higher or lower then the actual Highest and Lowest variables
     * overwrite Highest and Lowest variables. */
    if(vddp3 > g_SafetyKitStatus.voltStatus.vddp3VoltageHighest)
    {
        g_SafetyKitStatus.voltStatus.vddp3VoltageHighest = vddp3;
    }
    if(vddp3 < g_SafetyKitStatus.voltStatus.vddp3VoltageLowest)
    {
        g_SafetyKitStatus.voltStatus.vddp3VoltageLowest = vddp3;
    }
    g_SafetyKitStatus.voltStatus.vddp3Voltage = vddp3;

    /* We get the voltage result of the primary monitor */
    float32 coreVoltage = IfxPmsEvr_getAdcVddResult((float32)PMS_EVRADCSTAT.B.ADCCV);

    /* If new result is higher or lower then the actual Highest and Lowest variables
     * overwrite Highest and Lowest variables. */
    if(coreVoltage > g_SafetyKitStatus.voltStatus.coreVoltageHighest)
    {
        g_SafetyKitStatus.voltStatus.coreVoltageHighest = coreVoltage;
    }
    if(coreVoltage < g_SafetyKitStatus.voltStatus.coreVoltageLowest)
    {
        g_SafetyKitStatus.voltStatus.coreVoltageLowest  = coreVoltage;
    }
    g_SafetyKitStatus.voltStatus.coreVoltage = coreVoltage;
}
