 /**********************************************************************************************************************
 * \file I2C_Read_Ext_Device.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "Ifx_Types.h"
#include "IfxPort.h"
#include <IfxI2c_I2c.h>
#include <serialio.h>
#include <I2C_Read_Ext_Device.h>

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/
/* MCP79411 I2C PINS */
#define MCP_SCL_PIN                 IfxI2c0_SCL_P15_4_INOUT     /* SCL PIN                                          */
#define MCP_SDA_PIN                 IfxI2c0_SDA_P15_5_INOUT     /* SDA PIN                                          */
#define I2C_BAUDRATE                400000                      /* 400 kHz baud rate                                */

#define MCP79411_REGISTER_ADDRESS   0x6F                        /* 7 bit slave device address for reading from
                                                                     EEPROM of MCP79411 is 0x6F.                    */
#define ADDRESS_OF_REGISTER         0x07                        /* Location of MFP OUT pin register                 */
#define DATA                        0x80
#define LENGTH_OF_ADDRESS           1                           /* Length of address of the register                */
#define WRITING_LENGTH              2                           /* Length of the writing data                       */

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
IfxI2c_I2c g_i2cHandle;                                         /* I2C handle                                       */
IfxI2c_I2c_Device g_i2cDevEeprom;                               /* I2C Slave device handle to EEPROM of MC79411     */
uint8 g_macAddr[LENGTH_OF_ADDRESS] = {0};

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/

/* This function initializes the I2C in master mode and configures the MCP79411 (real time clock) as an I2C slave */
void init_I2C_module(void)
{
   /* It is possible to set the Pin 33.7 to activate the WAK signal*/

    /* Initialize module */
    IfxI2c_I2c_Config i2cConfig;                                    /* Create configuration structure               */
    IfxI2c_I2c_initConfig(&i2cConfig, &MODULE_I2C0);                /* Fill structure with default values and Module
                                                                       address                                      */
    /* I2c pin configuration */
    const IfxI2c_Pins MCP_PINS =
    {
            &MCP_SCL_PIN,                                           /* SCL port pin                                 */
            &MCP_SDA_PIN,                                           /* SDA port pin                                 */
            IfxPort_PadDriver_ttlSpeed1                             /* Pad driver mode                              */
    };
    i2cConfig.pins = &MCP_PINS;                                     /* Configure port pins                          */
    i2cConfig.baudrate = I2C_BAUDRATE;                              /* Configure baud rate with 400kHz              */

    IfxI2c_I2c_initModule(&g_i2cHandle, &i2cConfig);                /* Initialize module                            */

    /* Initialize device */
    IfxI2c_I2c_deviceConfig i2cDeviceConfig;                        /* Create device configuration                  */
    IfxI2c_I2c_initDeviceConfig(&i2cDeviceConfig, &g_i2cHandle);    /* Fill structure with default values and I2C
                                                                       Handler                                      */
    /* Because it is 7 bit long and bit 0 is R/W bit, the device address has to be shifted by 1 */
    i2cDeviceConfig.deviceAddress = MCP79411_REGISTER_ADDRESS << 1;
    IfxI2c_I2c_initDevice(&g_i2cDevEeprom, &i2cDeviceConfig);       /* Initialize the I2C device handle             */
}

/* This function executes the I2C data transfer.
 * It modify the register 0x07 to enable the .
 */
void read_ext_device_address(void)
{
    /* Initialize register address and the message */
    uint8 i2cTxBuffer = ADDRESS_OF_REGISTER;
    uint8 i2cMessage[2] = {ADDRESS_OF_REGISTER, DATA};

    /* Write data to device */
    while(IfxI2c_I2c_write(&g_i2cDevEeprom, &i2cMessage[0], WRITING_LENGTH) == IfxI2c_I2c_Status_nak);

    /* Read the register */
    while(IfxI2c_I2c_write(&g_i2cDevEeprom, &i2cTxBuffer, LENGTH_OF_ADDRESS) == IfxI2c_I2c_Status_nak);
    while(IfxI2c_I2c_read(&g_i2cDevEeprom, &g_macAddr[0], LENGTH_OF_ADDRESS) == IfxI2c_I2c_Status_nak);
}
