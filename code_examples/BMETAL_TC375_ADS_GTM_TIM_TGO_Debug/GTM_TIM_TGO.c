/**********************************************************************************************************************
 * \file GTM_TIM_TGO.c
 * \copyright Copyright (C) Infineon Technologies AG 2023
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "GTM_TIM_TGO.h"
#include "IfxGtm_Atom_Pwm.h"
#include "IfxGtm_Trig.h"
#include "IfxPort.h"
#include "IfxPort_PinMap.h"
#include "IfxStm.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/

/* Enable for GTM to OTGB */
#define TS16_IOS_ENABLE     1
#define TS16_IOS_DISABLE    0

/* Module to be connected to OTGB */
#define NO_MOD_TRIGGER      0   /* No Module selected */
#define TIM_MOD_TRIGGER     1   /* TIM (F_OUT[7:0]) */
#define TOML_MOD_TRIGGER    2   /* TOML (TOM_OUT[7:0]) */
#define TOMH_MOD_TRIGGER    3   /* TOMH (TOM_OUT[15:8]) */
#define ATOM_MOD_TRIGGER    4   /* ATOM (ATOM_OUT[7:0]) */
#define SPE_MOD_TRIGGER     5   /* SPE signals */
#define MISC_MOD_TRIGGER    6   /* MISC signals */

/* Cluster number */
#define CLUSTER0            0   /* cluster 0 */
#define CLUSTER1            1   /* cluster 1 */
#define CLUSTER2            2   /* cluster 2 */
#define CLUSTER3            3   /* cluster 3 */
#define CLUSTER4            4   /* cluster 4 */
#define CLUSTER5            5   /* cluster 5 */

/* Trigger line selection */
#define TRIGGER_LINE1       1
#define TRIGGER_LINE2       2
#define TRIGGER_LINE3       3
#define TRIGGER_LINE4       4
#define TRIGGER_LINE5       5
#define TRIGGER_LINE6       6
#define TRIGGER_LINE7       7

/* TGO Pulse Stretcher */
#define NO_PULSE_STRETCH    0
#define TWO_SPB_CLKS        1
#define FOUR_SPB_CLKS       2

/* TG Signal Processing */
#define SIGNAL_UNCHANGED    0
#define SIGNAL_INVERTED     1


/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/


void pinningGTM (void);
void enableGTM (void);
void configTIM (void);
void configATOM (void);
void configTIMtoTGO (void);

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/

/* This function uses iLLD to configure Aurix pins for the TIM and ATOM modules
 * */
void pinningGTM (void)
{
    /* ATOM0_CH0, P00.0 */
    IfxGtm_PinMap_setAtomTout(&IfxGtm_ATOM0_0_TOUT9_P00_0_OUT, IfxPort_OutputMode_pushPull, IfxPort_PadDriver_cmosAutomotiveSpeed1);
    /* ATOM0_CH1, P00.2 */
    IfxGtm_PinMap_setAtomTout(&IfxGtm_ATOM0_1_TOUT11_P00_2_OUT, IfxPort_OutputMode_pushPull, IfxPort_PadDriver_cmosAutomotiveSpeed1);
    /* TIM0_CH0, P00.9 */
    IfxGtm_PinMap_setTimTin(&IfxGtm_TIM0_0_P00_9_IN, IfxPort_InputMode_noPullDevice);
}

/* This function initializes the GTM-CMU:
 * - enables clock for GTM module
 * - disables cluster protections
 * - sets GTM-CLS0 clock with divider (100MHz)
 * - enables CMU_CLK0, CMU_CLK4
 * */
void enableGTM (void)
{
    IfxScuWdt_clearCpuEndinit(IfxScuWdt_getCpuWatchdogPassword());
    MODULE_GTM.CLC.B.DISR = 0x0;                /* enable clock for GTM module */
    IfxScuWdt_setCpuEndinit(IfxScuWdt_getCpuWatchdogPassword());

    MODULE_GTM.CTRL.B.RF_PROT = 0x0u;            /* SW RST, FORCEINT and SW RAM enabled */
    MODULE_GTM.CCM[0].PROT.B.CLS_PROT = 0x0;
    MODULE_GTM.CLS_CLK_CFG.B.CLS0_CLK_DIV = 0x2; /* cluster 0 is enabled with clock divider --> CLS0 = 100MHz */
    MODULE_GTM.CMU.CLK_EN.U = 0x2;               /* enable CMU_CLK0 */
}

/* This function configures the TIM0_CH0 to do AUX_IN XOR TIM_IN; AUX_IN is from the ATOM0_0
 * and routing internally, ATOM0_1 is connected externally to TIM_IN
 * */
void configTIM (void)
{

    /* TIM0_CH0 <-- ATOM0_CH0*/
    MODULE_GTM.CCM[0].TIM_AUX_IN_SRC.B.SRC_CH0 = 0x1;
    MODULE_GTM.CCM[0].TIM_AUX_IN_SRC.B.SEL_OUT_N_CH0 = 0x0;

    MODULE_GTM.TIM[0].CH0.ECTRL.B.USE_LUT = 0x2;    /* Enable LUT */
    MODULE_GTM.TIM[0].CH0.TDUC.B.TO_CNT2 = 0x66;    /* FOUT = TIM_IN XOR AUX_IN */

    MODULE_GTM.TIM[0].CH0.CTRL.B.TIM_EN = 0x1;      /* Enable TIM0_CH0 */
}

/* Configure ATOM0 channel 0 and 1 to generated PWM signal as master-slave
 * */
void configATOM (void)
{
    /* ATOM0_0 */
    MODULE_GTM.ATOM[0].CH0.CTRL.B.MODE = 0x2;       /* SOMP mode */
    MODULE_GTM.ATOM[0].CH0.CTRL.B.CLK_SRC_SR = 0x0; /* use CMU_CLK0 as clock for ATOM0_CH0_CN1 */
    MODULE_GTM.ATOM[0].CH0.CTRL.B.SL = 0x0;
    MODULE_GTM.ATOM[0].CH0.SR0.U = 1000;
    MODULE_GTM.ATOM[0].CH0.SR1.U = 500;
    MODULE_GTM.ATOM[0].CH0.CN0.U = 1000;
    MODULE_GTM.ATOM[0].CH0.CTRL.B.TRIGOUT = 0x1;

    /* ATOM0_1 */
    MODULE_GTM.ATOM[0].CH1.CTRL.B.MODE = 0x2;       /* SOMP mode */
    MODULE_GTM.ATOM[0].CH1.CTRL.B.CLK_SRC_SR = 0x0; /* use CMU_CLK0 as clock for ATOM0_CH0_CN1 */
    MODULE_GTM.ATOM[0].CH1.CTRL.B.SL = 0x0;
    MODULE_GTM.ATOM[0].CH1.SR0.U = 400;
    MODULE_GTM.ATOM[0].CH1.SR1.U = 700;
    MODULE_GTM.ATOM[0].CH1.CTRL.B.RST_CCU0 = 0x1;

    /* Enable and start the ATOM0 channel 0 and 1 */
    MODULE_GTM.ATOM[0].AGC.FUPD_CTRL.U = 0xA;       /* Enable force update mechanism */
    MODULE_GTM.ATOM[0].AGC.GLB_CTRL.U = 0xA0001;    /* Enable update channels and send SW trigger to update all CMx and SRCx */
    MODULE_GTM.ATOM[0].AGC.OUTEN_STAT.U = 0xA;      /* enable outputs [0]-[1] of ATOM[0] */
    MODULE_GTM.ATOM[0].AGC.ENDIS_STAT.U = 0xA;      /* enable channels [0] [1] of ATOM[0] */
}

/* Route the GTM TIM0 FOUT signals to the TGO pin
 * TIM0 -> OTGB0 -> Trigger line -> TGO0;
 * In this example trigger line 7 is used; can be changed to any another TL0-7
 * */
void configTIMtoTGO (void)
{
    /* Connect GTM TIM0 FOUT to the OTGB0 trigger bus */
    MODULE_GTM.OCDS.OTSS.B.OTGB0 = TS16_IOS_ENABLE;
    MODULE_GTM.OCDS.OTSC0.B.B0LMT = TIM_MOD_TRIGGER;    /* configure the module of interest; TIM is configured */
    MODULE_GTM.OCDS.OTSC0.B.B0LMI = CLUSTER0;           /* configure the cluster of interest; cluster0 is configured */

    /* Connect trigger bus 0(TIM0_CH0) to trigger line 7 and then to TGO0 */
    MODULE_CBS.TRTGB[0].L.B.TG0 = TRIGGER_LINE7;
    MODULE_CBS.TOPR.B.PIN0 = TRIGGER_LINE7;
    /* By default the signal is inverted; it is inverted again to get the original signal*/
    MODULE_CBS.TLC.B.TLSP7 = SIGNAL_INVERTED;
    MODULE_CBS.TOPPS.B.PIN0 = NO_PULSE_STRETCH;
}

/* This function configures and enables the required GTM modules for decoding the AK protocol
 * */
void configureStartGTM (void)
{
    enableGTM();
    pinningGTM();
    configTIM();
    configATOM();
    configTIMtoTGO();
}
