/**********************************************************************************************************************
 * \file AppBsp.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 * 
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of 
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 * 
 * Boost Software License - Version 1.0 - August 17th, 2003
 * 
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and 
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 * 
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all 
 * derivative works of the Software, unless such copies or derivative works are solely in the form of 
 * machine-executable object code generated by a source language processor.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE 
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS 
 * IN THE SOFTWARE.
 *********************************************************************************************************************/


/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "AppBsp.h"
#include "IfxPort.h"
#include "IfxPort_PinMap.h"
#include "IfxPort_reg.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/
#if USE_KIT_A2G_TC375_LITE
    /* Available Pins on AURIX lite Kit V2
     *
     *  P00.5  -> LED D1
     *  P00.6  -> LED D2
     *  P33.11 -> free (connect to Button 1)
     *  P33.12 -> free (PINB wake-up, set internal pullup)
     */
    #define APP_BSP_LED_1               5u
    #define APP_BSP_LED_2               6u

    #define APP_BSP_LED_MODULE          MODULE_P00
    #define APP_BSP_FIRST_LED_INDEX     APP_BSP_LED_1
    #define APP_BSP_LED_MASK            0x3u

    #define APP_BSP_SCR_ACTIVITY        AppBspScrPin_P0_4 /* SCR_P00.4 (TriCore P33.4) */
    #define APP_BSP_PINB                AppBspScrPin_P1_4 /* SCR_P01.4 (TriCore P33.12) */
#endif /* USE_KIT_A2G_TC375_LITE */

#if USE_KIT_A2G_TC397_5V_TFT
    /* Available Pins on Application Kit TC3X7 V2.0
     *
     *  P13.0  -> LED D107
     *  P13.1  -> LED D108
     *  P13.2  -> LED D109
     *  P13.3  -> LED D110
     *  P33.11 -> free (external button, set internal pullup)
     *  P33.12 -> free (PINB wake-up, set internal pullup)
     */
    #define APP_BSP_LED_1               0u
    #define APP_BSP_LED_2               1u
    #define APP_BSP_LED_3               2u
    #define APP_BSP_LED_4               3u

    #define APP_BSP_LED_MODULE          MODULE_P13
    #define APP_BSP_FIRST_LED_INDEX     APP_BSP_LED_1
    #define APP_BSP_LED_MASK            0xFu

    #define APP_BSP_SCR_ACTIVITY        AppBspScrPin_P0_4 /* SCR_P00.4 (TriCore P33.4) */
    #define APP_BSP_PINB                AppBspScrPin_P1_4 /* SCR_P01.4 (TriCore P33.12) */
#endif /* USE_KIT_A2G_TC397_5V_TFT */

#if USE_KIT_TC397_TRB
    /* Available Pins on TriBoard TC3X7 TH V2.0(1)
     *
     *  P20.11 -> LED D306
     *  P20.12 -> LED D307
     *  P20.13 -> LED D308
     *  P20.14 -> LED D309
     *  P33.11 -> Button S202
     *  P33.12 -> free (PINB wake-up, set internal pullup)
     */
    #define APP_BSP_LED_1               11u
    #define APP_BSP_LED_2               12u
    #define APP_BSP_LED_3               13u
    #define APP_BSP_LED_4               14u

    #define APP_BSP_LED_MODULE          MODULE_P20
    #define APP_BSP_FIRST_LED_INDEX     APP_BSP_LED_1
    #define APP_BSP_LED_MASK            0xFu

    #define APP_BSP_SCR_ACTIVITY        AppBspScrPin_P0_4 /* SCR_P00.4 (TriCore P33.4) */
    #define APP_BSP_PINB                AppBspScrPin_P1_4 /* SCR_P01.4 (TriCore P33.12) */
#endif /* USE_KIT_TC397_TRB */

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*--------------------------------------------Private Variables/Constants--------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
void configureAppBspScrPorts(void)
{
#if USE_KIT_A2G_TC375_LITE
    /* Available Pins on AURIX lite Kit V2 (under control of TriCore per default)
     *
     *   SCR I/O   |   TC3 I/O   |   AURIX lite Kit V2.0   |   SCR I/O   |   TC3 I/O   |   AURIX lite Kit V2.0
     * ----------- | ----------- | ----------------------- | ----------- | ----------- | -----------------------
     *    P00.0    |   P33.0     |   X2-28 (free)          |    P01.0    |   P34.1     |   n. a. (not connected)
     *    P00.1    |   P33.1     |   X2-29 (free)          |    P01.1    |   P33.9     |   X2-37 (free)
     *    P00.2    |   P33.2     |   X2-30 (free)          |    P01.2    |   P33.10    |   X2-38 (free)
     *    P00.3    |   P33.3     |   X2-31 (free)          |    P01.3    |   P33.11    |   X1-03 (free)
     *    P00.4    |   P33.4     |   X2-32 (free)          |    P01.4    |   P33.12    |   X1-04 (free)
     *    P00.5    |   P33.5     |   X2-33 (free)          |    P01.5    |   P33.13    |   X1-25 (free)
     *    P00.6    |   P33.6     |   X2-34 (free)          |    P01.6    |   P33.14    |   n. a. (not connected)
     *    P00.7    |   P33.7     |   X2-35 (see [^1])      |    P01.7    |   P33.15    |   n. a. (not connected)
     *
     * [^1]: Output for Power Down Input of DP83825
     */
    uint32 newRegValue;
    while(P33_PCSR.B.LCK)   /* Wait while any previous update of PCSR is done */
    {}
    /* handover P33.0 - P33.6, P33.9 - P33.13 to the SCR */
    newRegValue = P33_PCSR.U;
    newRegValue |= 0x3E7F;
    P33_PCSR.U = newRegValue;
#endif /* USE_KIT_A2G_TC375_LITE */

#if USE_KIT_A2G_TC397_5V_TFT
    /* Available Pins on Application Kit TC3X7 V2.0 (under control of TriCore per default)
     *
     *   SCR I/O   |   TC3 I/O   |   AppKit TFT TC3X7 V2.0   |   SCR I/O   |   TC3 I/O   |   AppKit TFT TC3X7 V2.0
     * ----------- | ----------- | ------------------------- | ----------- | ----------- | -------------------------
     *    P00.0    |   P33.0     |   n.a. (see [^1])         |    P01.0    |   P34.1     |   n. a. (not connected)
     *    P00.1    |   P33.1     |   X102-17 (free)          |    P01.1    |   P33.9     |   X102-37 (see [^3])
     *    P00.2    |   P33.2     |   X102-16 (free)          |    P01.2    |   P33.10    |   X102-38 (free)
     *    P00.3    |   P33.3     |   X102-15 (free)          |    P01.3    |   P33.11    |   X102-26 (free)
     *    P00.4    |   P33.4     |   X102-14 (free)          |    P01.4    |   P33.12    |   X102-18 (free)
     *    P00.5    |   P33.5     |   X102-13 (free)          |    P01.5    |   P33.13    |   n. a. (not connected)
     *    P00.6    |   P33.6     |   X102-20 (free)          |    P01.6    |   P33.14    |   n. a. (not connected)
     *    P00.7    |   P33.7     |   n. a. (see [^2])        |    P01.7    |   P33.15    |   n. a. (not connected)
     *
     * [^1]: PWM Signal for Acoustic beeper
     * [^2]: RTC Alarm Interrupt Input (SCU_REQ4)
     * [^3]: Input for Safe State Signal 1 from TLF35584
     */
    uint32 newRegValue;
    while(P33_PCSR.B.LCK)   /* Wait while any previous update of PCSR is done */
    {}
    /* handover P33.0 - P33.6, P33.10 - P33.12 to the SCR */
    newRegValue = P33_PCSR.U;
    newRegValue |= 0x1C7F;
    P33_PCSR.U = newRegValue;
#endif /* USE_KIT_A2G_TC397_5V_TFT */

#if USE_KIT_TC397_TRB
    /* Available Pins on TriBoard TC3X7 TH V2.0(1) (under control of TriCore per default)
     *
     *   SCR I/O   |   TC3 I/O   |   TriBoard TC3X7 TH V2.0   |   SCR I/O   |   TC3 I/O   |   TriBoard TC3X7 TH V2.0
     * ----------- | ----------- | -------------------------- | ----------- | ----------- | --------------------------
     *    P00.0    |   P33.0     |   X703-66 (free)           |    P01.0    |   P34.1     |   X704-69 (free)
     *    P00.1    |   P33.1     |   X703-67 (free)           |    P01.1    |   P33.9     |   X704-58 (see [^1])
     *    P00.2    |   P33.2     |   X703-65 (free)           |    P01.2    |   P33.10    |   X704-60 (see [^2])
     *    P00.3    |   P33.3     |   X703-63 (free)           |    P01.3    |   P33.11    |   X703-79 (Button S202)
     *    P00.4    |   P33.4     |   X703-68 (LED D302)       |    P01.4    |   P33.12    |   X703-80 (free)
     *    P00.5    |   P33.5     |   X702-41 (LED D303)       |    P01.5    |   P33.13    |   X704-62 (free)
     *    P00.6    |   P33.6     |   X703-64 (LED D304)       |    P01.6    |   P33.14    |   X704-64 (free)
     *    P00.7    |   P33.7     |   X703-77 (LED D305)       |    P01.7    |   P33.15    |   X704-66 (free)
     *
     * [^1]: Input for Safe State Signal 1 from TLF35584
     * [^2]: Output for Wake/Inhibit Input of TLF35584
     */
    uint32 newRegValue;
    while(P33_PCSR.B.LCK)   /* Wait while any previous update of PCSR is done */
    {}
    /* handover P33.0 - P33.7, P33.11 - P33.15 to the SCR */
    newRegValue = P33_PCSR.U;
    newRegValue |= 0xF8FF;
    P33_PCSR.U = newRegValue;
    while(P34_PCSR.B.LCK)   /* Wait while any previous update of PCSR is done */
    {}
    /* handover P34.1 to the SCR */
    newRegValue = P34_PCSR.U;
    newRegValue |= 0x0002;
    P34_PCSR.U = newRegValue;
#endif /* USE_KIT_TC397_TRB */
}

void configureAppBspStatusLeds(void)
{
    /* Configure LED pins as Output, PushPull */
    IfxPort_setGroupModeOutput(&APP_BSP_LED_MODULE, APP_BSP_FIRST_LED_INDEX, APP_BSP_LED_MASK,
                               IfxPort_Mode_outputPushPullGeneral, IfxPort_OutputIdx_general);
    /* Set all LEDs off */
    deactivateAppBspStateLed(AppBspStatusLed_1);
    deactivateAppBspStateLed(AppBspStatusLed_2);
#if (!USE_KIT_A2G_TC375_LITE)
    deactivateAppBspStateLed(AppBspStatusLed_3);
    deactivateAppBspStateLed(AppBspStatusLed_4);
#endif /* (!USE_KIT_A2G_TC375_LITE) */
}

void activateAppBspStateLed(const AppBspStatusLed ledId)
{
    switch(ledId)
    {
        case AppBspStatusLed_1:
            IfxPort_setPinLow(&APP_BSP_LED_MODULE, APP_BSP_LED_1);
            break;
        case AppBspStatusLed_2:
            IfxPort_setPinLow(&APP_BSP_LED_MODULE, APP_BSP_LED_2);
            break;
#if (!USE_KIT_A2G_TC375_LITE)
        case AppBspStatusLed_3:
            IfxPort_setPinLow(&APP_BSP_LED_MODULE, APP_BSP_LED_3);
            break;
        case AppBspStatusLed_4:
            IfxPort_setPinLow(&APP_BSP_LED_MODULE, APP_BSP_LED_4);
            break;
#endif /* (!USE_KIT_A2G_TC375_LITE) */
        default:
            /* intentional fall through */
            break;
    }
}

void deactivateAppBspStateLed(const AppBspStatusLed ledId)
{
    switch(ledId)
    {
        case AppBspStatusLed_1:
            IfxPort_setPinHigh(&APP_BSP_LED_MODULE, APP_BSP_LED_1);
            break;
        case AppBspStatusLed_2:
            IfxPort_setPinHigh(&APP_BSP_LED_MODULE, APP_BSP_LED_2);
            break;
#if (!USE_KIT_A2G_TC375_LITE)
        case AppBspStatusLed_3:
            IfxPort_setPinHigh(&APP_BSP_LED_MODULE, APP_BSP_LED_3);
            break;
        case AppBspStatusLed_4:
            IfxPort_setPinHigh(&APP_BSP_LED_MODULE, APP_BSP_LED_4);
            break;
#endif /* (!USE_KIT_A2G_TC375_LITE) */
        default:
            /* intentional fall through */
            break;
    }
}

void toggleAppBspStateLed(const AppBspStatusLed ledId)
{
    switch(ledId)
    {
        case AppBspStatusLed_1:
            IfxPort_togglePin(&APP_BSP_LED_MODULE, APP_BSP_LED_1);
            break;
        case AppBspStatusLed_2:
            IfxPort_togglePin(&APP_BSP_LED_MODULE, APP_BSP_LED_2);
            break;
#if (!USE_KIT_A2G_TC375_LITE)
        case AppBspStatusLed_3:
            IfxPort_togglePin(&APP_BSP_LED_MODULE, APP_BSP_LED_3);
            break;
        case AppBspStatusLed_4:
            IfxPort_togglePin(&APP_BSP_LED_MODULE, APP_BSP_LED_4);
            break;
#endif /* (!USE_KIT_A2G_TC375_LITE) */
        default:
            /* intentional fall through */
            break;
    }
}

boolean getPinState(AppBspScrPin pin)
{
    boolean pinState = FALSE;

    switch(pin)
    {
        case AppBspScrPin_P0_0:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_0.pinIndex);
            break;
        case AppBspScrPin_P0_1:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_1.pinIndex);
            break;
        case AppBspScrPin_P0_2:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_2.pinIndex);
            break;
        case AppBspScrPin_P0_3:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_3.pinIndex);
            break;
        case AppBspScrPin_P0_4:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_4.pinIndex);
            break;
        case AppBspScrPin_P0_5:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_5.pinIndex);
            break;
        case AppBspScrPin_P0_6:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_6.pinIndex);
            break;
        case AppBspScrPin_P0_7:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_7.pinIndex);
            break;
        case AppBspScrPin_P1_0:
            pinState = IfxPort_getPinState(&MODULE_P34, IfxPort_P34_1.pinIndex);
            break;
        case AppBspScrPin_P1_1:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_9.pinIndex);
            break;
        case AppBspScrPin_P1_2:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_10.pinIndex);
            break;
        case AppBspScrPin_P1_3:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_11.pinIndex);
            break;
        case AppBspScrPin_P1_4:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_12.pinIndex);
            break;
        case AppBspScrPin_P1_5:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_13.pinIndex);
            break;
        case AppBspScrPin_P1_6:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_14.pinIndex);
            break;
        case AppBspScrPin_P1_7:
            pinState = IfxPort_getPinState(&MODULE_P33, IfxPort_P33_15.pinIndex);
            break;
        default:
            /* intentional fall through */
            break;
    }

    return pinState;
}

void setPinState(AppBspScrPin pin, boolean high)
{
    IfxPort_State action;
    if(high)
    {
        action = IfxPort_State_high;
    }
    else
    {
        action = IfxPort_State_low;
    }

    switch(pin)
    {
        case AppBspScrPin_P0_0:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_0.pinIndex, action);
            break;
        case AppBspScrPin_P0_1:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_1.pinIndex, action);
            break;
        case AppBspScrPin_P0_2:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_2.pinIndex, action);
            break;
        case AppBspScrPin_P0_3:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_3.pinIndex, action);
            break;
        case AppBspScrPin_P0_4:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_4.pinIndex, action);
            break;
        case AppBspScrPin_P0_5:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_5.pinIndex, action);
            break;
        case AppBspScrPin_P0_6:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_6.pinIndex, action);
            break;
        case AppBspScrPin_P0_7:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_7.pinIndex, action);
            break;
        case AppBspScrPin_P1_0:
            IfxPort_setPinState(&MODULE_P34, IfxPort_P34_1.pinIndex, action);
            break;
        case AppBspScrPin_P1_1:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_9.pinIndex, action);
            break;
        case AppBspScrPin_P1_2:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_10.pinIndex, action);
            break;
        case AppBspScrPin_P1_3:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_11.pinIndex, action);
            break;
        case AppBspScrPin_P1_4:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_12.pinIndex, action);
            break;
        case AppBspScrPin_P1_5:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_13.pinIndex, action);
            break;
        case AppBspScrPin_P1_6:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_14.pinIndex, action);
            break;
        case AppBspScrPin_P1_7:
            IfxPort_setPinState(&MODULE_P33, IfxPort_P33_15.pinIndex, action);
            break;
        default:
            /* intentional fall through */
            break;
    }
}

void showTcActivity(void)
{
    if(getPinState(APP_BSP_SCR_ACTIVITY))
    {
        deactivateAppBspStateLed(STATUSLED_TCACTIVITY);
    }
    else
    {
        activateAppBspStateLed(STATUSLED_TCACTIVITY);
    }
}

boolean getButtonState(void)
{
    /* Read SCR_P01.3 (TriCore P33.11) */
    return getPinState(AppBspScrPin_P1_3);
}

void waitForButtonPress(void)
{
    /* Wait for SCR_P01.3 (TriCore P33.11) going LOW */
    while(getButtonState())
    {
        showTcActivity();
    }
}

boolean getPinBState(void)
{
    return getPinState(APP_BSP_PINB);
}
