/**********************************************************************************************************************
 * \file CDSP_TMADC_Filtering.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include <stdlib.h>
#include "IfxAdc_reg.h"
#include "IfxAdc.h"
#include "IfxSrc.h"
#include "IfxAdc_Cdsp.h"
#include "Ifx_reg.h"
#include "Platform_types.h"
#include "Bsp.h"
#include "CDSP_TMADC_Filtering.h"
#include "TMADC_Single_Channel.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/
#define CDSP_RES_SRV_REQ_PRIO       2                /* CDSP result service request priority                         */
#define CDSP_EVT_SRV_REQ_PRIO       3                /* CDSP event service request priority                          */
#define CDSP_ALM_SRV_REQ_PRIO       4                /* CDSP alarm service request priority                          */

#define CDSP_BND_CFG_UPPER_BOUND    0x700            /* CDSP output boundary checking config-upper bound             */
#define CDSP_BND_CFG_LOWER_BOUND    0x200            /* CDSP output boundary checking config-lower bound             */
#define CDSP_SRV_TRG_DELAY          100              /* CDSP service request trigger delay                           */
#define CDSP_BND_TRG_DELAY          150              /* CDSP boundary request trigger delay                          */

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
uint16 g_resultsCdsp[RESULT_TABLE_SIZE];                                     /* CDSP  Results Array                  */

IfxAdc_Cdsp_Config g_cdspConfig;                                             /* CDSP Module Configuration            */
IfxAdc_Cdsp_DspCoreConfig g_dspConfig;                                       /* DSP Core Configuration               */
IfxAdc_Cdsp g_cdspHandle;                                                    /* CDSP Module Handle                   */
IfxAdc_Cdsp_Dsp g_dspCore0Handle;                                            /* DSP Core Handle                      */

static volatile uint32 g_IrqCntCdsp =  0;                                    /* ISR counter for CDSP results         */

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
IFX_INTERRUPT(CDSP0SR0ISR, 0, CDSP_RES_SRV_REQ_PRIO);    /* Interrupt handler for CDSP result service request        */
IFX_INTERRUPT(CDSP0SR1ISR, 0, CDSP_EVT_SRV_REQ_PRIO);    /* Interrupt handler for CDSP event service request         */
IFX_INTERRUPT(CDSP0SR2ISR, 0, CDSP_ALM_SRV_REQ_PRIO);    /* Interrupt handler for CDSP alarm service request         */

/* This interrupt handler routine is invoked on a CDSP result service request */
void CDSP0SR0ISR()
{
    /* Index boundary check for CDSP results array */
    if (RESULT_TABLE_SIZE <= g_IrqCntCdsp)
    {
        g_IrqCntCdsp = 0;
    }

    /* Store the CDSP result value in the CDSP results array */
    g_resultsCdsp[g_IrqCntCdsp] = IfxAdc_Cdsp_readDspCoreResult(&g_dspCore0Handle);

    /* Increment index */
    g_IrqCntCdsp++;
}

/* This interrupt handler routine is invoked on a CDSP event service request */
void CDSP0SR1ISR()
{
}

/* This interrupt handler routine is invoked on a CDSP alarm service request */
void CDSP0SR2ISR()
{
}

/* This function configures CDSP core 0 */
void initCDSP0(void)
{
    IfxAdc_CdspCore myCoreId =  IfxAdc_CdspCore_0;

    /* LowerBoundary, Upper Boundary, Hyst Enable, SrvReq Cfg, Srv Enable, Boundary Mode */
    IfxAdc_Cdsp_BoundaryConfig boundaryCfg = {CDSP_BND_CFG_UPPER_BOUND, CDSP_BND_CFG_LOWER_BOUND,
            IfxAdc_CdspBoundaryServReq_outsideBoundary, IfxAdc_CdspBoundaryCmpMode_bothBound, TRUE};

    /* Trigger Configuration */
    IfxAdc_Cdsp_ServReqTrigger srvtrigger = {IfxAdc_CdspTriggerSel_0, CDSP_SRV_TRG_DELAY};
    IfxAdc_Cdsp_Trigger bndtrigger = {IfxAdc_CdspTriggerSel_5, IfxAdc_CdspTriggerMode_risingEdge, CDSP_BND_TRG_DELAY};
    IfxAdc_Cdsp_TriggerConfig trigCfg = {&srvtrigger, NULL_PTR, &bndtrigger, NULL_PTR};

    /* Service Request Configuration */
    IfxAdc_Cdsp_ResultSrvReq resSrvReq = {NULL_PTR, CDSP_RES_SRV_REQ_PRIO, IfxSrc_Tos_cpu0, IfxSrc_VmId_0,
            IfxAdc_CdspSrvReq0_always};
    IfxAdc_Cdsp_EventSrvReq  eventSrvReq = {CDSP_EVT_SRV_REQ_PRIO, IfxSrc_Tos_cpu0, IfxSrc_VmId_0,
            IfxAdc_CdspSrvReq1_wakeupErr};
    IfxAdc_Cdsp_AlarmSrvReq alarmSrvReq = {CDSP_ALM_SRV_REQ_PRIO, IfxSrc_Tos_cpu0, IfxSrc_VmId_0, TRUE};

    /* Memory Configuration */
    IfxAdc_Cdsp_MemoryConfig memoryCfg = {(void*)&cdspFcmIccmImage, (void*)&cdspFc0Dccm,
            (uint16)cdspFcmIccmImageSize, cdspFc0DccmSize};

    /* Module configuration structure to default values */
    IfxAdc_Cdsp_initModuleConfig(&g_cdspConfig, &MODULE_ADC);

    /* Module Initialization */
    IfxAdc_Cdsp_initModule(&g_cdspHandle, &g_cdspConfig);

    /* DSP core configuration structure to default values */
    IfxAdc_Cdsp_initDspCoreConfig(&g_dspConfig, &MODULE_ADC);

    g_dspConfig.coreId         = myCoreId;

    g_dspConfig.inputSel       = IfxAdc_CdspInput_tmadc0Res0;  /* TMADC0 input                                       */

    g_dspConfig.bndCfg         = &boundaryCfg;                  /* Boundary Configuration                             */
    g_dspConfig.triggerCfg     = &trigCfg;                      /* Trigger configuration                              */
    g_dspConfig.resSrvReqCfg   = &resSrvReq;                    /* Result Service request trigger                     */
    g_dspConfig.eventSrvReqCfg = &eventSrvReq;                  /* Wake-up Error Event service request trigger        */
    g_dspConfig.alarmSrvReqCfg = &alarmSrvReq;                  /* Alarm Service request trigger                      */

    g_dspConfig.resultCfg.readAsUnsigned = FALSE;
    g_dspConfig.resultCfg.disableFifo    = TRUE;
    g_dspConfig.resultCfg.dataReadWidth  = IfxAdc_CdspDataReadWidth_16Bit;
    g_dspConfig.resultCfg.fifoSrvLevel   = IfxAdc_CdspFifoSrLevel_1;

    g_dspConfig.memCfg = &memoryCfg;                            /* Link memory configuration to DSP core              */

    IfxAdc_Cdsp_initDspCore(&g_dspCore0Handle, &g_dspConfig);   /* Initialize DSP core                                */

    /* Wait for core to sleep post initialization */
    while(!IfxAdc_getCdspCoreSleepStatus(&MODULE_ADC.CDSP, IfxAdc_CdspCore_0));
}
