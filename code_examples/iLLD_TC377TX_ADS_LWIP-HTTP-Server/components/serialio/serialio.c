/**
 * \file serialio.c
 * \brief
 *
 * \version ASDK_0_6_0
 * \copyright Copyright (c) 2019-2020 Infineon Technologies AG. All rights reserved.
 *
 *
 *                                 IMPORTANT NOTICE
 *
 *
 * Use of this file is subject to the terms of use agreed between (i) you or 
 * the company in which ordinary course of business you are acting and (ii) 
 * Infineon Technologies AG or its licensees. If and as long as no such 
 * terms of use are agreed, use of this file is subject to following:


 * Boost Software License - Version 1.0 - August 17th, 2003

 * Permission is hereby granted, free of charge, to any person or 
 * organization obtaining a copy of the software and accompanying 
 * documentation covered by this license (the "Software") to use, reproduce,
 * display, distribute, execute, and transmit the Software, and to prepare
 * derivative works of the Software, and to permit third-parties to whom the 
 * Software is furnished to do so, all subject to the following:

 * The copyright notices in the Software and this entire statement, including
 * the above license grant, this restriction and the following disclaimer, must
 * be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are
 * solely in the form of machine-executable object code generated by a source
 * language processor.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
 * SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE 
 * FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 *
 */

#include "serialio.h"

#include "IfxAsclin_bf.h"

#define ASC_ERROR_MASK			((IFX_ASCLIN_FLAGS_PE_MSK << IFX_ASCLIN_FLAGS_PE_OFF) | \
								 (IFX_ASCLIN_FLAGS_FE_MSK << IFX_ASCLIN_FLAGS_FE_OFF) | \
								 (IFX_ASCLIN_FLAGS_RFO_MSK << IFX_ASCLIN_FLAGS_RFO_OFF))

#if defined(CONFIG_BOARD_SERIALIO_ENABLE)

void SERIALIO_Init(sint32 baudrate)
{
  IfxAsclin_enableModule(SERIALIO.asclin);                                  
  IfxAsclin_setClockSource(SERIALIO.asclin, IfxAsclin_ClockSource_noClock);
  IfxAsclin_setFrameMode(SERIALIO.asclin, IfxAsclin_FrameMode_initialise);
  
  IfxAsclin_setClockSource(SERIALIO.asclin, IfxAsclin_ClockSource_ascFastClock);
  IfxAsclin_setBitTiming(SERIALIO.asclin, baudrate, IfxAsclin_OversamplingFactor_16, IfxAsclin_SamplePointPosition_8, IfxAsclin_SamplesPerBit_three);
  IfxAsclin_setClockSource(SERIALIO.asclin, IfxAsclin_ClockSource_noClock);

  IfxAsclin_setStopBit(SERIALIO.asclin, IfxAsclin_StopBit_1);
  IfxAsclin_enableParity(SERIALIO.asclin, FALSE);
  IfxAsclin_setDataLength(SERIALIO.asclin, IfxAsclin_DataLength_8);

  IfxAsclin_setFrameMode(SERIALIO.asclin, IfxAsclin_FrameMode_asc);
  IfxAsclin_setClockSource(SERIALIO.asclin, IfxAsclin_ClockSource_ascFastClock);

  IfxAsclin_disableAllFlags(SERIALIO.asclin);
  IfxAsclin_clearAllFlags(SERIALIO.asclin);

  IfxAsclin_setTxFifoInletWidth(SERIALIO.asclin, IfxAsclin_TxFifoInletWidth_1);
  IfxAsclin_enableTxFifoOutlet(SERIALIO.asclin, TRUE);
  IfxAsclin_flushTxFifo(SERIALIO.asclin);

  IfxAsclin_setRxFifoOutletWidth(SERIALIO.asclin, IfxAsclin_TxFifoInletWidth_1);
  IfxAsclin_enableRxFifoInlet(SERIALIO.asclin, TRUE);
  IfxAsclin_flushRxFifo(SERIALIO.asclin);

  IfxAsclin_initRxPin(SERIALIO.rx_pin, IfxPort_InputMode_pullUp, IfxPort_PadDriver_cmosAutomotiveSpeed1);

  /* START_TX */
  SERIALIO.asclin->FLAGSSET.B.TFLS = 1;

  IfxAsclin_initTxPin(SERIALIO.tx_pin, IfxPort_OutputMode_pushPull, IfxPort_PadDriver_cmosAutomotiveSpeed1);
}

/* Check the serial line if a character has been received.
   returns 1 and the character in *chr if there is one
   else 0
 */
static int _poll_uart(unsigned char *chr)
{
  unsigned char ret;
  int res = 0;

  if (IfxAsclin_getRxFifoFillLevelFlagStatus(SERIALIO.asclin) == TRUE)
  {
    ret = (unsigned char)IfxAsclin_readRxData(SERIALIO.asclin);
	/* acknowledge receive */
    IfxAsclin_clearRxFifoFillLevelFlag(SERIALIO.asclin);
	/* check for error condition */
    if (IfxAsclin_getAllErrorFlagsStatus(SERIALIO.asclin) & ASC_ERROR_MASK)
	{
	  /* reset error flags */
      IfxAsclin_clearParityErrorFlag(SERIALIO.asclin);
      IfxAsclin_clearFrameErrorFlag(SERIALIO.asclin);
      IfxAsclin_clearRxFifoOverflowFlag(SERIALIO.asclin);
	  /* ignore this character */
	}
	else
	{
	  /* this is a valid character */
	  *chr = ret;
	  res = 1;
	}
  }

  return res;
}


/* POSIX read function */
/* read characters from file descriptor fd into given buffer, at most count bytes */
/* returns number of characters in buffer */
size_t read(int fd, void *buffer, size_t count)
{
  size_t index = 0;

  if (fileno(stdin) == fd)
  {
	unsigned char *ptr = (unsigned char *)buffer;
	do
	{
      if (1 == _poll_uart(ptr))
	  {
		++ptr;
		++index;
	  }
	  else
	  {
		/* wait at least for 1 character */
		if (index >= 1)
		{
		  break;
		}
	  }
	} 
	while (index < count);
  }

  return index;
}

/* POSIX write function */
/* write content of buffer to file descriptor fd */
/* returns number of characters that have been written */
size_t write(int fd, const void *buffer, size_t count)
{
  size_t index = 0;

  if ((fileno(stdout) == fd) || (fileno(stderr) == fd))
  {
	const unsigned char *ptr = (const unsigned char *)buffer;
	while (index < count)
	{
      /* wait until space is available in the FIFO */
      while (IfxAsclin_getTxFifoFillLevelFlagStatus(SERIALIO.asclin) != TRUE);

      IfxAsclin_clearTxFifoFillLevelFlag(SERIALIO.asclin);

      /* send the character */
      IfxAsclin_writeTxData(SERIALIO.asclin, *ptr++);

	  ++index;
	}
  }

  return index;
}

void _putchar(char character)
{
  while (IfxAsclin_getTxFifoFillLevelFlagStatus(SERIALIO.asclin) != TRUE);

  IfxAsclin_clearTxFifoFillLevelFlag(SERIALIO.asclin);

  /* send the character */
  IfxAsclin_writeTxData(SERIALIO.asclin, character);
}

#endif
