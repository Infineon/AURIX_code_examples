/**
 * \file TmadcCmds.c
 * \brief Source file of TMADC commands for AscLin Shell
 *
 * \copyright Copyright (c) 2022 Infineon Technologies AG. All rights reserved.
 *
 *
 *
 *                                 IMPORTANT NOTICE
 *
 *
 * Use of this file is subject to the terms of use agreed between (i) you or
 * the company in which ordinary course of business you are acting and (ii)
 * Infineon Technologies AG or its licensees. If and as long as no such
 * terms of use are agreed, use of this file is subject to following:


 * Boost Software License - Version 1.0 - August 17th, 2003

 * Permission is hereby granted, free of charge, to any person or
 * organization obtaining a copy of the software and accompanying
 * documentation covered by this license (the "Software") to use, reproduce,
 * display, distribute, execute, and transmit the Software, and to prepare
 * derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:

 * The copyright notices in the Software and this entire statement, including
 * the above license grant, this restriction and the following disclaimer, must
 * be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are
 * solely in the form of machine-executable object code generated by a source
 * language processor.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
 * SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
 * FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.

 *
 */

/******************************************************************************/
/*----------------------------------Includes----------------------------------*/
/******************************************************************************/
#include "Software_Config.h"
#if  (defined(__ghs__) && ((CPU_WHICH_SERVICE_ASC_SHELL == 4) || (CPU_WHICH_SERVICE_ASC_SHELL == 5)))
#pragma ghs callmode=far
#endif
#include "SysSe/Comm/Ifx_Shell.h"
#include "TmadcCmds.h"
#include "TmadcAutoScan.h"

/******************************************************************************/
/*-----------------------------------Macros-----------------------------------*/
/******************************************************************************/

/******************************************************************************/
/*--------------------------------Enumerations--------------------------------*/
/******************************************************************************/

/******************************************************************************/
/*-----------------------------Data Structures--------------------------------*/
/******************************************************************************/

/******************************************************************************/
/*------------------------------Global variables------------------------------*/
/******************************************************************************/
#if CPU_WHICH_SERVICE_ASC_SHELL == 0
    #if defined(__HIGHTEC__)
    #if defined(__clang__)
    #pragma clang section text=".text_cpu0" bss=".bss_cpu0" data=".data_cpu0" rodata=".rodata_cpu0"
    #else
    #pragma section ".text_cpu0" ax
    #pragma section ".bss_cpu0" awc0
    #endif
    #endif
    #if defined(__TASKING__)
    #pragma section code    "text_cpu0"
    #pragma section farbss  "bss_cpu0"
    #pragma section fardata "data_cpu0"
    #pragma section farrom  "rodata_cpu0"
    #endif
    #if defined(__DCC__)
    #pragma section CODE ".text_cpu0"
    #pragma section DATA ".data_cpu0" ".bss_cpu0" far-absolute RW
    #pragma section CONST ".rodata_cpu0"
    #endif
    #if defined(__ghs__)
    #pragma ghs section text=".text_cpu0"
    #pragma ghs section bss= ".bss_cpu0"
    #pragma ghs section data=".data_cpu0"
    #pragma ghs section rodata=".rodata_cpu0"
    #endif
#elif ((CPU_WHICH_SERVICE_ASC_SHELL == 1) && (CPU_WHICH_SERVICE_ASC_SHELL < IFXCPU_NUM_MODULES))
    #if defined(__HIGHTEC__)
    #if defined(__clang__)
    #pragma clang section text=".text_cpu1" bss=".bss_cpu1" data=".data_cpu1" rodata=".rodata_cpu1"
    #else
    #pragma section ".text_cpu1" ax
    #pragma section ".bss_cpu1" awc1
    #endif
    #endif
    #if defined(__TASKING__)
    #pragma section code    "text_cpu1"
    #pragma section farbss  "bss_cpu1"
    #pragma section fardata "data_cpu1"
    #pragma section farrom  "rodata_cpu1"
    #endif
    #if defined(__DCC__)
    #pragma section CODE ".text_cpu1"
    #pragma section DATA ".data_cpu1" ".bss_cpu1" far-absolute RW
    #pragma section CONST ".rodata_cpu1"
    #endif
    #if defined(__ghs__)
    #pragma ghs section text=".text_cpu1"
    #pragma ghs section bss= ".bss_cpu1"
    #pragma ghs section data=".data_cpu1"
    #pragma ghs section rodata=".rodata_cpu1"
    #endif
#elif ((CPU_WHICH_SERVICE_ASC_SHELL == 2) && (CPU_WHICH_SERVICE_ASC_SHELL < IFXCPU_NUM_MODULES))
    #if defined(__HIGHTEC__)
    #if defined(__clang__)
    #pragma clang section text=".text_cpu2" bss=".bss_cpu2" data=".data_cpu2" rodata=".rodata_cpu2"
    #else
    #pragma section ".text_cpu2" ax
    #pragma section ".bss_cpu2" awc2
    #endif
    #endif
    #if defined(__TASKING__)
    #pragma section code    "text_cpu2"
    #pragma section farbss  "bss_cpu2"
    #pragma section fardata "data_cpu2"
    #pragma section farrom  "rodata_cpu2"
    #endif
    #if defined(__DCC__)
    #pragma section CODE ".text_cpu2"
    #pragma section DATA ".data_cpu2" ".bss_cpu2" far-absolute RW
    #pragma section CONST ".rodata_cpu2"
    #endif
    #if defined(__ghs__)
    #pragma ghs section text=".text_cpu2"
    #pragma ghs section bss= ".bss_cpu2"
    #pragma ghs section data=".data_cpu2"
    #pragma ghs section rodata=".rodata_cpu2"
    #endif
#elif ((CPU_WHICH_SERVICE_ASC_SHELL == 3) && (CPU_WHICH_SERVICE_ASC_SHELL < IFXCPU_NUM_MODULES))
    #if defined(__HIGHTEC__)
    #if defined(__clang__)
    #pragma clang section text=".text_cpu3" bss=".bss_cpu3" data=".data_cpu3" rodata=".rodata_cpu3"
    #else
    #pragma section ".text_cpu3" ax
    #pragma section ".bss_cpu3" awc3
    #endif
    #endif
    #if defined(__TASKING__)
    #pragma section code    "text_cpu3"
    #pragma section farbss  "bss_cpu3"
    #pragma section fardata "data_cpu3"
    #pragma section farrom  "rodata_cpu3"
    #endif
    #if defined(__DCC__)
    #pragma section CODE ".text_cpu3"
    #pragma section DATA ".data_cpu3" ".bss_cpu3" far-absolute RW
    #pragma section CONST ".rodata_cpu3"
    #endif
    #if defined(__ghs__)
    #pragma ghs section text=".text_cpu3"
    #pragma ghs section bss= ".bss_cpu3"
    #pragma ghs section data=".data_cpu3"
    #pragma ghs section rodata=".rodata_cpu3"
    #endif
#elif ((CPU_WHICH_SERVICE_ASC_SHELL == 4) && (CPU_WHICH_SERVICE_ASC_SHELL < IFXCPU_NUM_MODULES))
    #if defined(__HIGHTEC__)
    #if defined(__clang__)
    #pragma clang section text=".text_cpu4" bss=".bss_cpu4" data=".data_cpu4" rodata=".rodata_cpu4"
    #else
    #pragma section ".text_cpu4" ax
    #pragma section ".bss_cpu4" awc4
    #endif
    #endif
    #if defined(__TASKING__)
    #pragma section code    "text_cpu4"
    #pragma section farbss  "bss_cpu4"
    #pragma section fardata "data_cpu4"
    #pragma section farrom  "rodata_cpu4"
    #endif
    #if defined(__DCC__)
    #pragma section CODE ".text_cpu4"
    #pragma section DATA ".data_cpu4" ".bss_cpu4" far-absolute RW
    #pragma section CONST ".rodata_cpu4"
    #endif
    #if defined(__ghs__)
    #pragma ghs section text=".text_cpu4"
    #pragma ghs section bss= ".bss_cpu4"
    #pragma ghs section data=".data_cpu4"
    #pragma ghs section rodata=".rodata_cpu4"
    #endif
#elif ((CPU_WHICH_SERVICE_ASC_SHELL == 5) && (CPU_WHICH_SERVICE_ASC_SHELL < IFXCPU_NUM_MODULES))
    #if defined(__HIGHTEC__)
    #if defined(__clang__)
    #pragma clang section text=".text_cpu5" bss=".bss_cpu5" data=".data_cpu5" rodata=".rodata_cpu5"
    #else
    #pragma section ".text_cpu5" ax
    #pragma section ".bss_cpu5" awc5
    #endif
    #endif
    #if defined(__TASKING__)
    #pragma section code    "text_cpu5"
    #pragma section farbss  "bss_cpu5"
    #pragma section fardata "data_cpu5"
    #pragma section farrom  "rodata_cpu5"
    #endif
    #if defined(__DCC__)
    #pragma section CODE ".text_cpu5"
    #pragma section DATA ".data_cpu5" ".bss_cpu5" far-absolute RW
    #pragma section CONST ".rodata_cpu5"
    #endif
    #if defined(__ghs__)
    #pragma ghs section text=".text_cpu5"
    #pragma ghs section bss= ".bss_cpu5"
    #pragma ghs section data=".data_cpu5"
    #pragma ghs section rodata=".rodata_cpu5"
    #endif
#else
#error "Set CPU_WHICH_SERVICE_ASC_SHELL to a valid value!"
#endif

/******************************************************************************/
/*-------------------------Function Prototypes--------------------------------*/
/******************************************************************************/

/******************************************************************************/
/*------------------------Private Variables/Constants-------------------------*/
/******************************************************************************/

#if defined(__HIGHTEC__) && !defined(__clang__)
#pragma section /* end bss section, now text section selected */
#endif
/******************************************************************************/
/*-------------------------Function Implementations---------------------------*/
/******************************************************************************/
/** \brief Handle the 'showan' command
 *
 * \par Syntax
 *  - showan x y: show the values of ANx until ANy
 */
boolean Show_ANx_y(pchar args, void *data, IfxStdIf_DPipe *io)
{
    uint32  chnNrStart, chnNrEnd, uiValue, chnNr;
	boolean result_valid;

    if (Ifx_Shell_matchToken(&args, "?") != FALSE)
    {
        IfxStdIf_DPipe_print(io, "Syntax     : showan x"ENDL);
        IfxStdIf_DPipe_print(io, "           > Show the value of ANx"ENDL);
        return TRUE;
    }
    /* first we get the first argument */
    chnNrStart = 0;
    if (Ifx_Shell_parseUInt32(&args, &chnNrStart, FALSE) == FALSE)
       {
           IfxStdIf_DPipe_print(io, "Syntaxerror : invalid AN number %s"ENDL, args);
           return TRUE;
       }
       chnNr = (MAX_ANALOG_CHANNELS-1);
       if ((((*(uint32 *)(0xAE400008)) >> 22) & 0xF) == 0x7)
       {
           /* this is a BGA292 device */
       	if (*(uint32 *)(0xAE400008) & 0x1)
       		/* this is a STD device */
       	    chnNr -= 24;
       	else
       	    chnNr -= 40;
       }
    if (chnNrStart > chnNr)
    {
        IfxStdIf_DPipe_print(io, "Syntaxerror : invalid AN number %d"ENDL, chnNrStart);
        return TRUE;
    }
    /* get the second argument if exist */
    chnNrEnd = 0;
    if (Ifx_Shell_parseUInt32(&args, &chnNrEnd, FALSE) == FALSE)
       {
        chnNrEnd = chnNrStart;
       }
    else
    {
        chnNr = (MAX_ANALOG_CHANNELS-1);
        if ((((*(uint32 *)(0xAE400008)) >> 22) & 0xF) == 0x7)
        {
            /* this is a BGA292 device */
        	if (*(uint32 *)(0xAE400008) & 0x1)
        		/* this is a STD device */
        	    chnNr -= 24;
        	else
        	    chnNr -= 40;
        }
    }
    if (chnNrEnd > chnNr)
    {
        IfxStdIf_DPipe_print(io, "Syntaxerror : invalid AN number %d"ENDL, chnNrEnd);
        return TRUE;
    }

    for (chnNr = chnNrStart; chnNr <= chnNrEnd; chnNr++)
    {
    	result_valid = IfxAdc_isTmadcResultAvailable(g_TmadcAutoScan.adcChannel[chnNr].modSFR, g_TmadcAutoScan.adcChannel[chnNr].resultRegNum);
    	uiValue = IfxAdc_Tmadc_readChannelResult(&g_TmadcAutoScan.adcChannel[chnNr]);

        if (result_valid)
            IfxStdIf_DPipe_print(io, "AN%d : 0x%04X %05d %01fV"ENDL, chnNr, uiValue, uiValue, 5.0f/4095.0f*(float)uiValue);
        else
            IfxStdIf_DPipe_print(io, "AN%d : 0x%04X %05d %01fV (no RESEV bit)"ENDL, chnNr, uiValue, uiValue, 5.0f/4095.0f*(float)uiValue);
    }

    return TRUE;
}

#if defined(__HIGHTEC__)
#if defined(__clang__)
#pragma clang section text="" bss="" data="" rodata=""
#else
#pragma section /* end text section */
#endif
#endif
#if defined(__TASKING__)
#pragma section code restore
#pragma section fardata restore
#pragma section farbss restore
#pragma section farrom restore
#endif
#if defined(__DCC__)
#pragma section CODE
#pragma section DATA RW
#pragma section CONST
#endif
#if defined(__ghs__)
#pragma ghs callmode=default
#pragma ghs section text=default
#pragma ghs section data=default
#pragma ghs section bss=default
#pragma ghs section rodata=default
#endif
