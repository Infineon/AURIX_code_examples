/**********************************************************************************************************************
 * \file SMU_IR_Alarm.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 * 
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of 
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 * 
 * Boost Software License - Version 1.0 - August 17th, 2003
 * 
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and 
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 * 
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all 
 * derivative works of the Software, unless such copies or derivative works are solely in the form of 
 * machine-executable object code generated by a source language processor.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE 
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS 
 * IN THE SOFTWARE.
 *********************************************************************************************************************/


/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/

#include "SMU_IR_Alarm.h"
#include "IfxSmu.h"
#include "IfxSrc.h"
#include "IfxPort.h"


/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/

/* Interrupt Service Routine of SMU, gets triggered when the SMU Software Alarm 0 is triggered */
void ISR_SMU_Alarm(void)
{
    /* Clear alarm status flag                   */
    IfxSmu_smuSafeClearAlarmStatus(IfxSmu_Alarm_SF_SMU_SmuSafe0SoftwareAlarm0, SMU_SAFE0_INDEX);
    /* Clear Alarm Execution Status register bit */
    IfxSmu_clearSafetyAlarmExecutedStatus(SMU_SAFE0_INDEX, IfxSmu_AlarmExecutionStatus_irq0);
    /* Turn on LED (LED is low-level active)     */
    IfxPort_setPinState(LED, IfxPort_State_low);
}

/* This function configures the SMU module to trigger an interrupt if a software alarm occurs */
void configure_SMU(void)
{
    volatile Ifx_SRC_SRCR *src; /*Declare local SRC pointer variable*/

    /* -------------------------------------------PORTS configuration------------------------------------------------*/
    /* Configure LED pin */
    IfxPort_setPinMode(LED, IfxPort_Mode_outputPushPullGeneral);
    /* Turn off LED (LEDs are low-level active) */
    IfxPort_setPinState(LED, IfxPort_State_high);


    /* ---------------------------------------------SMU configuration----------------------------------------------- */
    /* Configure the alarm handling for the Software Alarm 0 of SMU_SAFE0. This alarm is configured to trigger the
     * reaction IGCS_REQ0. The function below sets the SAFE0_AGSFi_CONj registers accordingly                        */
    IfxSmu_setSafetyAlarmAction(IfxSmu_Alarm_SF_SMU_SmuSafe0SoftwareAlarm0, IfxSmu_InternalAlarmAction_igcs0_req,
            SMU_SAFE0_INDEX);
    /* Configure the Interrupt Generation Configuration Set 0 of SMU_SAFE0 to assert the SMU Interrupt Request line 0
     * only.
     * This is done by setting the IGCS0 field of the SAFE0_AGC register to 0b001                                    */
    IfxSmu_safetyConfigureInterruptGeneration(IfxSmu_InterruptGenerationConfiguration_IGC_0, SMU_SAFE0_INDEX,
            IfxSmu_InterruptRequest_IR_0);
    /*Note: unlocking and locking of the SMU configuration is performed within the iLLD functions above*/


    /* ------------------------------------Interrupt Router service request configuration--------------------------- */
    /* Get source pointer of SMU Service Request 0 in order to initialize and enable it */
    src = &SRC_SMU_IRQ0;
    IfxSrc_init(src, IfxSrc_Tos_cpu0, ISR_PRIORITY_SMU_INT0, SRC_VM_INDEX);
    IfxSrc_enable(src);

    /* Start the SMU state machine (SSM) SSM0 of SMU_SAFE0. SSM1 can remain disabled */
    IfxSmu_smuSafeActivateRunState(SMU_SAFE0_INDEX, SMU_SAFEx_SSM0_INDEX);
}

/* This function triggers the Software Alarm 0 */
void trigger_SMU_alarm(void)
{
    /* Trigger Software Alarm 0 of SMU_SAFE0 through the SMU_SAFE control interface of SSM0 */
    IfxSmu_setSafetyAlarmStatus(IfxSmu_Alarm_SF_SMU_SmuSafe0SoftwareAlarm0, SMU_SAFE0_INDEX, SMU_SAFEx_SSM0_INDEX);
}
