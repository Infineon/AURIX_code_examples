/**********************************************************************************************************************
 * \file EEPROM.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 * 
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of 
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 * 
 * Boost Software License - Version 1.0 - August 17th, 2003
 * 
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and 
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 * 
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all 
 * derivative works of the Software, unless such copies or derivative works are solely in the form of 
 * machine-executable object code generated by a source language processor.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE 
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS 
 * IN THE SOFTWARE.
 *********************************************************************************************************************/


/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "EEPROM.h"
#include "UART_Config.h"
#include "TLE4973.h"
#include "Main_Config.h"

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
uint8 EEPROMCRCArray[EEPROM_CRC_LEN];
uint16 EEPROMArray[EEPROM_LEN];

/*********************************************************************************************************************/
/*--------------------------------------------Private Variables/Constants--------------------------------------------*/
/*********************************************************************************************************************/
static const uint8 eepromAddress[] = {0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48, 0x49, 0x4A, 0x4B, 0x4C, 0x4D, 0x4E, 0x4F, 0x50, 0x51, 0x52, 0x53};

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/

/* This function transform the uint16 EEPROM array into a uint8 array. */
void createArrayForEEPCRC(void)
{
    /* cycle from line 3 to line 17 */
    for(uint8 eepCount = 3; eepCount < 18; eepCount++)
    {
        EEPROMCRCArray[2 * (eepCount - 3)] = ((EEPROMArray[eepCount] & 0xFF00) >> 8);
        EEPROMCRCArray[(2 * (eepCount - 3)) + 1] = (EEPROMArray[eepCount] & 0xFF);
    }
    /* add EEPROM line 0 and 1 */
    for(uint8 eepCount = 0; eepCount < 2; eepCount++)
    {
        EEPROMCRCArray[(2 * eepCount) + 30] = ((EEPROMArray[eepCount] & 0xFF00) >> 8);
        EEPROMCRCArray[(2 * eepCount) + 30 + 1] = (EEPROMArray[eepCount] & 0xFF);
    }
    /* add high byte of line 2 */
    EEPROMCRCArray[34] = ((EEPROMArray[2] & 0xFF00)  >> 8);
}

/* This function calculate the EPPROM CRC using EEPROMCRCArray[]. */
uint8 calculateEEPCRC(void)
{
    uint32 crc;
    uint8 res;
    createArrayForEEPCRC();

    crc = EEPROM_CRC_SEED;
    for (uint8 i = 0; i < EEPROM_CRC_LEN; i++)
    {
        crc ^= EEPROMCRCArray[i];
        for (uint8 bit = 0; bit < 8; bit++)
        {
            if ((crc & 0x80) != 0)
            {
                crc <<= 1;
                crc ^= EEPROM_CRC_POLY;
            }
            else
            {
                crc <<= 1;
            }
        }
    }
    res = crc & 0xFF;
    res = ~ res;
    return res;
}

/* This function store all the EEPROM in EEPROMArray[]. */
void readEEPROM(uint8 deviceID)
{
    writeHLCommand(UNLOCKRegAddr, UNLOCK, deviceID);
    writeHLCommand(ISMRegAddr, DISABLE_ISM, deviceID);
    Waitms(1);
    /* read all eeprom registers */
    for(uint8 Count = 0; Count < EEPROM_LEN; Count++)
    {
        EEPROMArray[Count] = readHLCommand(eepromAddress[Count], deviceID);
        Waitms(1);
    }
}

/* This function burn the EEPROM. */
void programEEPROM(uint8 deviceID)
{
    writeHLCommand(UNLOCKRegAddr, UNLOCK, deviceID);
    Waitms(3);
    writeHLCommand(ISMRegAddr, DISABLE_ISM, deviceID);
    Waitms(3);
    writeHLCommand(FAILRegAddr, DISABLE_EEPROM_CRC, deviceID);

    EEPROMArray[EEPROM42h] &= (0xFF00);
    EEPROMArray[EEPROM42h] |= calculateEEPCRC();                        /* calculate CRC value */

    writeHLCommand(EEPROMRegAddr, SET_EEPROM_ZERO, deviceID);
    Waitms(3);
    writeHLCommand(EEPROMRegAddr, PROGRAMME_EEPROM_ZERO, deviceID);
    Waitms(30);

    /* write all eeprom registers */
    for(uint8 Count = 0; Count < EEPROM_LEN; Count++)
    {
        writeHLCommand(eepromAddress[Count], EEPROMArray[Count], deviceID);
    }

    writeHLCommand(EEPROMRegAddr, PROGRAMME_EEPROM_ONE, deviceID);
    Waitms(30);
    writeHLCommand(EEPROMRegAddr, EEPROM_REFRESH, deviceID);
    Waitms(10);
    sendReset(deviceID);
    Waitms(10);
}


void addNewEEPROMValue(uint16 data, EEPROMLine addr)
{
    EEPROMArray[addr] = data;
}

uint16 getEEPROMValue(EEPROMLine addr)
{
    return EEPROMArray[addr];
}
